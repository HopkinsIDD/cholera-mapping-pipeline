## Basic test setup starting from real data
library(taxdat)
library(sf)

dbuser <- Sys.getenv("USER", "app")
dbname <- Sys.getenv("CHOLERA_COVAR_DBNAME", "cholera_covariates")

conn_pg <- taxdat::connect_to_db(dbuser, dbname)
DBI::dbClearResult(DBI::dbSendQuery(conn = conn_pg, "SET client_min_messages TO WARNING;"))

# generate_seed <- function() {
#   rnorm(1,1)
#   seed <- .GlobalEnv$.Random.seed
#   write.csv(seed,file="seed.csv")
#   return(as.integer(read.csv(file = "seed.csv")[[2]]))
# }
# 
# idx=1
# while(sum(all_dfs$observations_df$cases)<200){
  
#my_seed <- generate_seed()
#my_seed<-as.integer(read.csv(file = "seed.csv")[[2]])

print(paste0(as.integer(read.csv(file = "C:/IDD/Cholera/test case country data reports back up/moving_to_dev_jk_qz/seed.csv")[[2]]),collapse=","))

my_seed<-c(
  10403,467,-367560760,-344123045,-1504140581,-1920270017,1627738083,1899832105,90503307,-1957489328,1679565350,
  698111349,985972909,-1749570451,586721369,-1844007678,-557843677,2075917572,-2101422393,-1444230061,57311905,
  239189691,1553386327,1028047065,-2080658467,-1209540605,-149399432,707948763,982900417,821731674,-298964351,
  -1884244452,2051750413,-1703095354,-1981744500,-1868204228,-657445790,170103137,481553725,-1653833031,832221939,
  2063381785,683757376,-107813697,480790414,-694789722,-1728339768,626212230,1216366276,940112673,-826092166,
  -583762450,1761797740,-2121430003,-1360254415,693598227,-771051618,2076673930,-199926942,-1739361236,1312500540,
  777233410,-633147597,440142737,1675003599,-518694472,-382456411,-1723057541,-992255035,1887834299,-1619074835,
  1820477542,-487905700,727341575,1742588893,1731939667,997297837,-2085191676,-900776450,-1151448722,1031704546,
  -1983100296,-418317592,1093893913,1317566473,-238926204,-1375139564,1033769543,2054115141,1299122825,1675250226,
  1535803530,-1462877231,-987920566,1180270336,985596150,1432172288,425853183,1139103276,1176714998,1447093691,
  -1654272545,1858543443,1311584220,-1456715196,-1169689909,-921522804,-663062128,1954801623,988286887,-1475013325,
  -1950642115,1016968279,1643745846,2013325881,-709947378,294340020,817583350,-293269528,36396251,1639326328,490256085,
  1257147747,735907227,809863380,-263713935,971956609,577156507,1787754293,-55101604,-120374085,-1107788420,693886410,
  605749525,-379344115,-1649139162,65032495,-43562960,32170955,1414447783,-1724262211,624125341,-1504087322,1546799794,
  -1957796676,-734664542,1215554908,-1150016356,-475917460,217740266,2075848649,1763492294,-1561393918,-795508411,
  -2061356906,-1288027957,644118288,1070976862,-1106282453,-17467285,-586110713,967101024,1947832144,715468577,1821871572,
  -1800645062,-865457649,-2024567643,584463652,-352262017,8544119,913326960,1083610013,134785781,923282923,1620688989,
  1229307059,-1212466918,2094243570,1505197822,-283288587,-829682351,1513975906,-1528370536,1352798471,-424632517,
  -256477495,-1399488051,613960333,754694668,-1700498637,-496719179,-856800475,48045843,1670269814,538793078,986661696,
  -474854524,1360810144,1830574526,1249630067,1885816076,1946244119,-1547520816,1194812710,1915034321,2065740926,982464126,
  1485864221,-925893634,-1886590162,-377031598,-1777532940,-1908393839,-1875557763,-1337095915,739063051,1486625629,
  -1847599523,-759073239,-1940592218,2088025118,2100826193,1382209229,-1261069191,-268107612,1531984742,-1104012566,
  189602313,814038196,-57266757,372150047,-1990877294,106935469,983677154,-349386126,1092266646,1710082653,-499790,
  1642121247,-1249063193,-1350297559,-768891599,-155856089,-1764181887,-528262768,599929468,577770925,-1400098309,
  -2003507960,-543846518,1191391697,1873240009,521993642,-1025417085,-1209413765,-1605898975,1070805653,70602891,19169123,
  825150557,1894173497,-1490627996,-889004717,191084884,-950900145,-562803446,-1185827688,-1648860099,-64051798,-1670127101,
  -93804402,-1069554905,472867477,-848722879,452735529,846371464,777400891,-1632216232,-1481430793,357798238,824760099,
  -1077913507,411702402,1307706851,-1197410969,-63389454,-976819133,607689982,856373719,-577367451,1724530469,-654807848,
  -1126097476,-1769658799,-1284686202,813152967,-481217950,1338029408,1754629413,1824794069,-1892514032,-1311344391,225736342,
  -1906355206,1095818775,-953267543,-1838047374,21707140,258578618,-1023979412,-292831717,-299343774,-643477228,-1401572362,
  763942423,441013307,-172467180,1871293265,798609561,-255067804,61934343,761897132,1458942837,-1448077259,773878631,
  -1341775201,-1456095612,1229359230,302175212,693103335,-811376937,1917196557,1345888732,-188323320,-223251212,-1155330815,
  663089501,-101680980,-1037817620,622851911,-2146043571,1654792393,1415334647,-1309393623,2094404164,1560104598,1591946593,
  -312739333,-1964474509,-2099434595,-1383673341,219114790,1887884151,1117968250,1160295580,-1407729693,1659375328,-1647305726,190945543,
  -198166630,212314875,-37072847,-1079470205,-928924708,-1321568370,-1957344305,-218862101,1479560662,-1016927000,871571994,1587626823,
  534284481,113425352,-1067731034,-1289287762,-89142634,293502078,-1814509937,1184179608,1372568031,-94815623,-1249095610,-668016427,
  1129202748,-1598196471,1390744051,-1551328349,-926397544,1204499267,-51755122,204926747,-892624209,-1891264330,-1825855177,-227009566,
  963117175,2140906279,-1756491695,-294995893,1821848301,901935171,-340169488,1602353644,1785558202,1315157996,1246549874,-735506774,
  -99175844,95506705,-1182902492,2064371538,1553764104,-768149553,533113924,1839210058,709247035,-1233004369,691024234,-118195786,
  -66720970,1786491377,-922122547,-542496486,-1408236780,1270753466,137870079,-963502210,-581536465,-1499192521,-1551646709,
  -1552240405,2136662972,598646881,-1028193878,-641821160,-615137739,1003297949,376213538,470027686,1084496593,-6563974,2108574869,
  -156931551,2082765628,607987014,1884771941,28559619,792061155,-576868799,-1529101695,897950873,371344698,-924904766,472063143,
  418762715,1860124462,-320160945,424655171,2023373144,2117371547,-1627422407,-796368384,1756493909,-1646666057,-1689316960,1445110768,
  1269461832,-731062042,-1991912474,-1381000791,1529710087,880066194,-1944542746,-1116973409,417979093,426843355,-1351707395,
  -1127034344,644006776,-1793782113,-704636783,1472196861,-1872676539,1755791887,981384406,-1303277948,891310076,1235047712,
  -1251239384,1075683014,1703773168,195946891,50830860,-932780850,-1273679036,-1250122352,2003360857,-104409161,-749953051,
  -1808946626,1582037485,-1262581905,-1781091408,1494527813,-1295928681,-710248295,1591766743,-118673277,1272863126,-347826607,
  652077765,1807584570,2073054801,63140451,2135327500,-1073621566,1297700371,-1747773240,-25065637,1778509893,402785372,
  -784501278,623200251,903407681,1510618795,-1069684272,1753724571,-794148384,767175175,1195464830,-29008698,-864420118,-1805445265,
  1493229534,-2135292591,-1282898396,-1336608534,-1527638496,-729790723,-18216118,-1567063079,-1476171627,1684523742,981308172,
  -1495207465,-1584299592,-687637778,-1550809968,-1335703893,1113146219,-25032903,968479218,1508879863,652257824,1794354375,
  1631496742,-580391929,-159369218,1668122526,-473420926,1328491697,1518607033,-1035909481,-1512452998,1752725127,1394346941,
  -944826743,-1665250426,-1156323162,-524756261,967921455,-252405156,-1892269424,-554765064,-754634168,-900142267,77505067,
  1162010558,-2058644098,-798709607,398509346,-1441458782,-1915330763,-1328949614,324457004,1813500488,-1845104996,-1756541309,
  -773331753,265502262,1801611615,-1529965798,1006488731,1997623532,840184675,-1842318519,-1058329124,-1657204059,-149718823,
  -1626226976,-1558429405,-318530266,161669446,616961538,702110131,292722013,-1042928139,-216387133,1063972255,1638781361,
  1514669176,-508256955,338132423,1391662516,1109661721,-644344270,249387348,-1657243839,-392726056,-786240349,-1973831763,
  -1002823665,1750486874,1541170731,-498750539
)%>%as.integer()

# my_seed <- c(
#   10403,12,1235579427,-536490051,-1474526166,-1243979237,936407911,565438754,1449575741,319694383,
#   745753380,-1499589091,1317135575,367582367,-497616923,-1383406906,1041201250,-758780777,-697571325,
#   -1746075096,679503042,-26956654,-1340834598,795482303,-1910278852,-1757431244,-1706273351,
#   2117410134,-1818518651,-683209438,987698909,-1755235241,1141036153,1930540532,816396146,300759582,
#   1389470383,793779138,-1499359232,-917739079,-529345582,170612330,1795366836,1399573748,-18273887,
#   -505300133,693884152,-419929423,280008176,1771886754,415655228,1938803096,-948584482,1250221583,
#   1126787237,-998271449,443321931,-1429087907,225806708,-1179049429,-1586551469,-1925097111,125811782,
#   1124006490,-531787182,181316884,-366382455,1117307707,1995781958,-56878654,314897075,-1759894302,
#   948224285,-1162061563,-855698322,-1180428761,-1660219114,-1368751317,-233240988,-1832659731,
#   1550481992,-90807505,249905560,-1371629890,-2096047779,1672400464,-766330052,-1218070313,1950805981,
#   1448616474,1376864805,-1390190772,129491567,224248525,1379201047,858303543,1535906859,-219534484,
#   -771062028,-1583017493,-1841170751,554998902,1146291980,-1728151132,-1785091356,-300982018,-714119643,
#   -724102300,446865237,-942726615,398069839,840862798,35178785,-1944145796,486676555,-1890102954,
#   480285138,1567831125,-832852494,142164755,557240530,-68787035,-1364606872,-570672710,168347938,
#   -1411794576,1311178779,-2047204151,-793735057,1521450336,-1251938330,27804588,1510100110,250329201,
#   384270970,-291313602,1507068067,5019166,1789022220,-813318371,-1142269857,161783140,1433187590,
#   1077126149,188064124,1945034219,-1899159348,1366776547,-1003653749,-1363385947,-2028236510,-147576189,
#   -951767159,-752784387,-1445221421,-1697303836,1407586532,-584120513,1767024051,1140789005,718443016,
#   1785337607,1600135351,2074172144,-1626466749,169410259,-1958475353,-2032999608,-2135627811,-246169423,
#   1956160975,481802129,1361715019,-193502431,361010034,2120205051,1073930962,157352418,-912598332,
#   -174471038,-231655969,1357854794,686404828,-1302540581,1266127000,1178372736,1468989180,272613009,
#   -819576805,-298531194,1437536264,-1524651510,-139768586,562705084,-26397007,-1154507412,151801207,
#   -312930717,1309408538,-2020618381,-1914903493,-1723957780,-605516520,-346907432,544968988,963127556,
#   547795731,-1138803622,-59461585,1011378880,-1347677711,449082601,-1927557244,750045976,-23574297,
#   -1601190933,-1681049548,906047874,1756584656,-1961592272,-409751351,-563138938,-1414346754,-1955378415,
#   -9362132,-1529671792,-630900563,-1705818001,682129641,-1552647983,1787339043,-515871249,1504407537,
#   1547344086,1732240917,326386595,-340977879,1770424857,305871445,60471715,-1918485647,2146282306,
#   1425689001,-1745758872,-1677379574,-1325487695,1182472576,687485197,254714037,-1931131364,-146786547,
#   2138946010,-1307021502,512802145,1586656628,-2073582446,1286300926,451517383,-56140101,-1736366049,
#   -629882536,645144148,1331503924,2067664205,128564111,918530297,191425894,1913269688,-168295519,618559992,
#   -1372984528,1014154572,-1143882768,62853123,-1768394944,1184455282,-1725404623,1236430255,-330076992,
#   91518977,1683380711,1413842295,-176052388,1013027776,-195645770,1705349785,1221223008,1002223074,
#   919391368,-1825813938,-1745744026,1457524941,752471680,23559094,55785115,1335236178,98845753,309159539,
#   1319376122,-1341027244,-1930307808,-1177570877,1171027783,-1021544264,-228846076,-2107288877,-1207535689,
#   -416691441,-1070619165,2095985240,-1600836909,-2035253163,-187997714,1634451853,-146503377,-571105879,
#   -306743111,-838423418,1644654842,609861878,882144119,-43940637,-1128653018,-1683811811,1927970951,
#   1717333572,-1574169982,-578878873,-955347298,2072939103,1610462173,1922339955,1992036517,-1293138670,
#   207806031,-1999585717,-1329315235,1937590567,390472703,-1167118509,2082672619,-1180404305,1633721955,
#   -226741557,1925536403,636819475,195072370,1793567858,-1482651215,-1564202066,-587319516,1253880941,
#   -1608340027,911798871,1298134104,-1976589760,-2078682190,-1223851623,-55907376,-458338464,-1572753424,
#   1287742088,-276726832,-1732874239,-206741381,911842166,-655000460,-199841950,-765443832,1028695477,
#   1665172457,-725442766,1148477035,761030757,1437172586,1302405012,1997802097,949347595,1762231603,
#   1351232647,868943108,127315241,677732456,946805674,1257831106,-101335053,-963300656,393040815,-1822544237,
#   -780906615,1012809773,-1526953682,-1767655169,-2120011254,276309025,-1408774822,1386084358,1734965961,
#   -197840369,-132660466,-1397678259,-262769995,1831235444,1977323337,1397981701,-139132656,-1426108035,
#   1965764735,-1436308320,1474355278,-2094919089,399409927,-1858740424,1540597975,-369400358,277628388,901116811,
#   1423596555,1525481700,431818515,-1554541155,-656234554,164365236,-1105062481,1182820875,-1733549053,
#   722793898,-837969358,2029798273,-2025849004,467004396,-1246174162,1329512505,-1426312710,270602309,
#   -340391138,935711187,31403611,-1458325895,-1155279896,900282096,1693148522,-1015643878,1272532027,
#   -122699502,1246152629,1070824912,-246913917,-1645440105,-656889690,1479602573,1343401202,-1091823056,
#   724167309,-1943927586,-100609865,311658737,747811855,-1584251730,1614374529,-688095878,1279012131,-4748213,
#   450166909,-400659461,1716702279,1659583787,1178875538,1465661767,1043786113,-856038286,2015110614,1925853282,
#   -1180815023,1723555657,1102482433,-1697128033,-1455078575,192945070,-1064450513,2130797658,1035853257,915912577,
#   -420605105,1961592877,1994380412,295588698,1574825123,1151350522,949471851,-977200829,-1016521853,1224769786,
#   -2037253388,654023383,-1069476964,-301005781,91305367,897417982,-1259562742,-1457119034,-161908524,409082688,
#   -906467950,-1486887655,174558437,-971058484,845704858,-1070570388,714146234,1330014144,-598878428,-1694369183,
#   1224245431,-1689346446,297280996,1221876288,-1207219666,1391818565,1225853528,2134188662,-1474432433,225608997,
#   -752107627,-1564417142,1842129253,57858514,-864670645,-313854880,-1523812457,-1185802270,-1331870490,-1702756193,
#   -1279375136,-970556582,-305925447,-721239987,326899671,1351057537,905560817,754837826,216671555,1704785016,-203181263,
#   71401872,-1388077314,-2039741688,1739478367,-35592481,661940349,-1639779580,629186363,-106585053,-1390419936,1639907163,
#   -2040855977,1892481696,-1352493705,1463058596,1825371393,1851093212,1070721010,-711479072,1769386148,961950065,
#   -1871589301,197043640,1912080162,-1365510675,671700928,2009315278,-318696867,-1048209462,238413961,-1046396462,
#   -411570165,-1067380455,-753325789,-1411234662,862141148,2001384216,-1095109421,2108116079,-442273760,-466619710,
#   1435157800,1571519618,117759252,-368173505,586579402,916061794,-2049802502,-1874158496,-926835699,741167573,
#   1469426977,310173147,311713435,1380661583,835864418,-45467227,2102864420,-87525861,-1993191671,-1640915842,-343676543,
#   -1048088977,-2077878146,1382339926,-1144726400,-1036372051,550350861,-1340093134,-779516978,-567269794,1700562070,
#   -2122448835,-512293284,-43230255,-1452912746,1014259737,1189318989,263517052,-537815888,-1071695163,1240415169
# ) %>%
#   as.integer()

.GlobalEnv$.Random.seed<-my_seed

query_time_left <- lubridate::ymd("2000-01-01")
query_time_right <- lubridate::ymd("2001-12-31")
## Pull data frames needed to create testing database from the api This doesn't
## pull covariates, but does pull everything else tryCatch({ all_dfs <-
## taxdat::create_testing_dfs_from_api( username
## =Sys.getenv('CHOLERA_API_USERNAME'), api_key =
## Sys.getenv('CHOLERA_API_KEY'), locations = 'AFR::KEN', time_left =
## query_time_left, time_right = query_time_right, uids = NULL, website =
## 'https://api.cholera-taxonomy.middle-distance.com/' ) }, error = function(e)
## { })
load(rprojroot::find_root_file(criterion = ".choldir", "Analysis", "all_dfs_object.rdata"))
nlayers<-2

## ------------------------------------------------------------------------------------------------------------------------
## Change polygons
test_extent <- sf::st_bbox(all_dfs$shapes_df)
test_raster <- create_test_raster(nrows = 10, ncols = 10, nlayers = nlayers, test_extent = test_extent)
test_polygons <- sf::st_make_valid(create_test_layered_polygons(
  test_raster = test_raster,
  base_number = 1, n_layers = 2, factor = 10 * 10, snap = FALSE, randomize = TRUE,
  seed = my_seed
))
my_seed <- .GlobalEnv$.Random.seed

all_dfs$shapes_df <- test_polygons %>%
  dplyr::mutate(
    qualified_name = location, start_date = min(all_dfs$shapes_df$start_date),
    end_date = max(all_dfs$shapes_df$end_date)
  )
names(all_dfs$shapes_df)[names(all_dfs$shapes_df) == "geometry"] <- "geom"
sf::st_geometry(all_dfs$shapes_df) <- "geom"

all_dfs$location_period_df <- all_dfs$shapes_df %>%
  sf::st_drop_geometry()
all_dfs$location_df <- all_dfs$shapes_df %>%
  sf::st_drop_geometry() %>%
  dplyr::group_by(qualified_name) %>%
  dplyr::summarize()

## ------------------------------------------------------------------------------------------------------------------------
## Change covariates
covariates_table <- data.frame(
  nonspatial = c(FALSE, FALSE,TRUE,TRUE,TRUE,TRUE), nontemporal = c(
    FALSE,
    FALSE, FALSE,FALSE,FALSE,FALSE
  ), spatially_smooth = c(TRUE, TRUE, FALSE,TRUE,FALSE,FALSE), temporally_smooth = c(
    FALSE,
    FALSE, FALSE,FALSE,FALSE,FALSE
  ), polygonal = c(TRUE, TRUE, TRUE,TRUE,TRUE,TRUE), radiating = c(FALSE, FALSE, FALSE,FALSE,FALSE,FALSE),
  constant = c(TRUE, FALSE, FALSE,FALSE,FALSE,FALSE), Data_simulation_covariates = c(
    TRUE, TRUE,
    TRUE,TRUE,FALSE,FALSE
  ), Model_covariates = c(TRUE, TRUE, TRUE,FALSE,TRUE,TRUE)
)

test_extent <- sf::st_bbox(all_dfs$shapes_df)
test_raster <- create_test_raster(nrows = 10, ncols = 10, nlayers = nlayers, test_extent = test_extent)

test_covariates<-create_multiple_test_covariates(
  test_raster = test_raster, ncovariates = dim(covariates_table)[1],
  nonspatial = covariates_table$nonspatial, nontemporal = covariates_table$nontemporal,
  spatially_smooth = covariates_table$spatially_smooth, temporally_smooth = covariates_table$temporally_smooth,
  polygonal = covariates_table$polygonal, radiating = covariates_table$radiating,
  constant = covariates_table$constant, seed = my_seed
)
min_time_left <- query_time_left
max_time_right <- query_time_right
my_seed <- .GlobalEnv$.Random.seed

covariate_raster_funs_observation <- taxdat:::convert_simulated_covariates_to_test_covariate_funs(
  test_covariates[covariates_table$Data_simulation_covariates],
  min_time_left, max_time_right
)

covariate_raster_funs<- taxdat:::convert_simulated_covariates_to_test_covariate_funs(
  test_covariates[covariates_table$Model_covariates],
  min_time_left, max_time_right
)

for (cov_datagen_idx in 2:(length(covariate_raster_funs_observation)/nlayers)){
  covariate_raster_funs_observation[[cov_datagen_idx*2]]$name<-rep(paste0("covariate",rownames(covariates_table[covariates_table$Data_simulation_covariates,])),each=nlayers)[cov_datagen_idx*2]
  covariate_raster_funs_observation[[cov_datagen_idx*2-1]]$name<-rep(paste0("covariate",rownames(covariates_table[covariates_table$Data_simulation_covariates,])),each=nlayers)[cov_datagen_idx*2-1]
}
for (cov_model_idx in 2:(length(covariate_raster_funs)/nlayers)){
  covariate_raster_funs[[cov_model_idx*2]]$name<-rep(paste0("covariate",rownames(covariates_table[covariates_table$Model_covariates,])),each=nlayers)[cov_model_idx*2]
  covariate_raster_funs[[cov_model_idx*2-1]]$name<-rep(paste0("covariate",rownames(covariates_table[covariates_table$Model_covariates,])),each=nlayers)[cov_model_idx*2-1]
}
test_covariates_observation_final<-test_covariates[covariates_table$Data_simulation_covariates]

## save additional covariates in the data generation process for country data
## report
rds_file <- file.path(rprojroot::find_root(criterion = ".choldir"), "Analysis", "data", "test_case_1a_data_simulation_covariates_0823.rds")
if (!dir.exists(dirname(rds_file))) {
  dir.create(dirname(rds_file))
}
saveRDS(test_covariates_observation_final, rds_file)

## ------------------------------------------------------------------------------------------------------------------------
## Change observations
raster_df <- taxdat::convert_test_covariate_funs_to_simulation_covariates(covariate_raster_funs_observation)

test_underlying_distribution <- create_underlying_distribution(
  covariates = raster_df,
  seed = my_seed
)
my_seed <- .GlobalEnv$.Random.seed

test_observations <- observe_polygons(
  test_polygons = dplyr::mutate(all_dfs$shapes_df,
                                location = qualified_name, geometry = geom
  ), test_covariates = raster_df, underlying_distribution = test_underlying_distribution,
  noise = FALSE, number_draws = 1, grid_proportion_observed = 1, polygon_proportion_observed = 1,
  min_time_left = query_time_left, max_time_right = query_time_right, seed = my_seed
)
my_seed <- .GlobalEnv$.Random.seed

all_dfs$observations_df <- test_observations %>%
  dplyr::mutate(
    observation_collection_id = draw, time_left = time_left, time_right = time_right,
    qualified_name = location, primary = TRUE, phantom = FALSE, suspected_cases = cases,
    deaths = NA, confirmed_cases = NA
  )
print(idx)
idx=idx+1
print(sum(all_dfs$observations_df$cases))
#}

# overlapping observations with consistent case counts
all_dfs$observations_df[which(all_dfs$observations_df$qualified_name == "1"), ]$suspected_cases <- all_dfs$observations_df[which(all_dfs$observations_df$qualified_name == "1"), ]$suspected_cases

test_true_grid_cases <- test_underlying_distribution$mean
# label grids that is observed
observed_polygon_id <- c(unique(data.frame(sf::st_join(st_centroid(test_true_grid_cases), sf::st_as_sf(all_dfs$observations_df))) %>% subset(is.na(location) == F) %>% subset(!qualified_name == "1") %>% dplyr::select(id)))
observed_test_true_grid_cases <- test_true_grid_cases %>% subset(id %in% observed_polygon_id$id)
test_true_grid_cases <- test_true_grid_cases %>% mutate(observed = ifelse(id %in% observed_polygon_id$id, "Observed grid cells", "Unobserved grid cells"))

rds_file <- file.path(rprojroot::find_root(criterion = ".choldir"), "Analysis", "data", "test_case_1a_true_grid_cases_0823.rds")
if (!dir.exists(dirname(rds_file))) {
  dir.create(dirname(rds_file))
}
saveRDS(test_true_grid_cases, rds_file)

## ------------------------------------------------------------------------------------------------------------------------
## Create Database
setup_testing_database(conn_pg, drop = TRUE)
taxdat::setup_testing_database_from_dataframes(conn_pg, all_dfs, covariate_raster_funs)

## NOTE: Change me if you want to run the report locally config_filename <-
## paste(tempfile(), 'yml', sep = '.')
config_filename <- file.path(rprojroot::find_root(criterion = ".choldir"), "Analysis", "configs", "config_test_case_1a_0823.yml")
if (!dir.exists(dirname(config_filename))) {
  dir.create(dirname(config_filename))
}

## Put your config stuff in here
config <- list(general = list(
  location_name = all_dfs$location_df$qualified_name[[1]],
  start_date = as.character(min_time_left), end_date = as.character(max_time_right),
  width_in_km = 1, height_in_km = 1, time_scale = "year", covariates = unique(sapply(
    covariate_raster_funs,
    function(x) {
      x$name
    }
  ))
), stan = list(
  directory = rprojroot::find_root_file(
    criterion = ".choldir",
    "Analysis", "Stan"
  ), ncores = 4, model = "dagar_seasonal_flexible.stan", niter = as.integer(Sys.getenv("CHOLERA_TEST_ITERATION", 4000)),
  recompile = TRUE
), file_names = list(stan_input = rprojroot::find_root_file(
  criterion = ".choldir",
  "Analysis", "output", "test1a.stan_input_0823.rdata"
), stan_output = rprojroot::find_root_file(
  criterion = ".choldir",
  "Analysis", "output", "test1a.stan_output_0823.rds"
)), test_metadata = list(
  name = "test_1a_0823",
  nrows = 10, ncols = 10, data_type = "Grid data", oc_type = "-", polygon_type = "Fake polygon",
  polygon_coverage = "100%", randomize = TRUE, ncovariates = nrow(covariates_table),
  single_year_run = ifelse(lubridate::year(query_time_right) - lubridate::year(query_time_left) ==
                             0, "yes", "no"), nonspatial = covariates_table$nonspatial, nontemporal = covariates_table$nontemporal,
  spatially_smooth = covariates_table$spatially_smooth, temporally_smooth = covariates_table$temporally_smooth,
  polygonal = covariates_table$polygonal, radiating = covariates_table$radiating,
  constant = covariates_table$constant, Data_simulation_covariates = covariates_table$Data_simulation_covariates,
  Model_covariates = covariates_table$Model_covariates, Observations_with_inconsistent_data = paste0(
    "Nationally reported data is 1 times of the cases reported at the subnational level."
  ),
  Loc_with_inconsistent_data = "-",
  Cov_data_simulation_filename = file.path(rprojroot::find_root(criterion = ".choldir"), "Analysis", "data", "test_case_1a_data_simulation_covariates_0823.rds"),
  test_true_grid_case_filename = file.path(rprojroot::find_root(criterion = ".choldir"), "Analysis", "data", "test_case_1a_true_grid_cases_0823.rds")
))

yaml::write_yaml(x = config, file = config_filename)

Sys.setenv(CHOLERA_CONFIG = config_filename)
source(rprojroot::find_root_file(criterion = ".choldir", "Analysis", "R", "execute_pipeline.R"))
rmarkdown::render(
  rprojroot::find_root_file(
    criterion = ".choldir", "Analysis", "output",
    "country_data_report.Rmd"
  ),
  params = list(
    cholera_directory = rprojroot::find_root(criterion = ".choldir"),
    config = config_filename,
    drop_nodata_years = TRUE
  ),
  output_file = "test_case_1a_country_data_report_0823"
)
