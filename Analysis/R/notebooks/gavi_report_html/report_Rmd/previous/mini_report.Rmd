---
title: "Preliminary country cholera estimates"
author: "Johns Hopkins IDD, December 2021"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    number_sections: false
params:
  cholera_directory: "."
---

```{r setup, include=FALSE, dev="CairoPNG"}
knitr::opts_chunk$set(inlude = FALSE, dev = "CairoPNG")
knitr::opts_chunk$set(
  echo = FALSE,
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  cache.lazy = F,
  bitmapType = "cairo"
)
library(tidyverse)
library(kableExtra)
library(colorspace)
library(wpp2019)
library(countrycode)
```

```{r readdata}
bad <- read_csv("gavi_summary_bad.csv") %>% ## lancet numbers are wrong
  dplyr::select(country, contains("estimate"))
gha <- data.frame(country = "GHA", WHO_estimate = mean(c(692, 175, 0, 1))) ## no data reported for 2018
tza <- data.frame(country = "TZA", WHO_estimate = mean(c(11563, 11360, 4895, 4777))) ## no 2019 data reported
bad <- dplyr::bind_rows(bad, gha, tza)

gavi <- read_csv("gavi_summary.csv") %>%
  dplyr::select(-X1) %>%
  left_join(bad, by = c("country"))
need_manual_WHO <- gavi[which(!gavi$country %in% bad$country), ]$country
```

```{r popdata}
data(codelist, package = "countrycode")
data(pop, package = "wpp2019")
country_cw <- dplyr::select(codelist, iso3n, iso3c) %>%
  dplyr::filter(!is.na(iso3n) & !is.na(iso3c))
pop <- pop[, c("country_code", "name", "2015", "2020")] ## get 2015 & 2020 estimates only
names(pop) <- c("iso3n", "country", "p2015", "p2020")
popdf <- dplyr::inner_join(country_cw, pop, by = c("iso3n")) %>%
  dplyr::mutate(pop = rowMeans(cbind(p2015, p2020), na.rm = TRUE) * 1000) %>% ## mean of 2015 & 2020 pop estimates
  dplyr::select(iso3c, pop)
```

```{r prepdata}
datlong <- dplyr::left_join(gavi, popdf, by = c("country" = "iso3c")) %>%
  dplyr::rowwise() %>%
  dplyr::mutate(
    WHO_cases_quantile_low = quantile(rpois(1000, WHO_estimate), probs = c(.025), na.rm = TRUE),
    WHO_cases_quantile_high = quantile(rpois(1000, WHO_estimate), probs = c(.975), na.rm = TRUE)
  ) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(
    WHO_rates = WHO_estimate / pop,
    WHO_rates_quantile_low = WHO_cases_quantile_low / pop,
    WHO_rates_quantile_high = WHO_cases_quantile_high / pop,
    UNICEF_rates = UNICEF_estimate / pop
  ) %>%
  dplyr::select(-pop) %>%
  dplyr::mutate(swap_current_who = ifelse(current_cases_mean / lancet_cases_mean == 1, T, F)) %>%
  dplyr::mutate(
    current_rates_mean = ifelse(swap_current_who, WHO_rates, current_rates_mean),
    current_rates_quantile_high = ifelse(swap_current_who, WHO_rates_quantile_high, current_rates_quantile_high),
    current_rates_quantile_low = ifelse(swap_current_who, WHO_rates_quantile_low, current_rates_quantile_low),
    current_cases_mean = ifelse(swap_current_who, WHO_estimate, current_cases_mean),
    current_cases_quantile_high = ifelse(swap_current_who, WHO_cases_quantile_high, current_cases_quantile_high),
    current_cases_quantile_low = ifelse(swap_current_who, WHO_cases_quantile_low, current_cases_quantile_low)
  ) %>%
  dplyr::mutate(
    current_rates_mean = ifelse(is.na(current_rates_mean), 0, current_rates_mean),
    current_cases_mean = ifelse(is.na(current_cases_mean), 0, current_cases_mean)
  ) %>%
  # dplyr::select(-swap_current_who) %>%
  pivot_longer(cols = c(-country, -swap_current_who), names_to = c("source", "type", "q", "dummy"), names_sep = "_", values_to = "value") %>%
  dplyr::mutate(
    type = ifelse(type == "estimate", "cases", type),
    q = ifelse(q == "quantile", dummy, q)
  ) %>%
  dplyr::select(-dummy) %>%
  dplyr::mutate(q = ifelse(is.na(q), "mean", q)) %>%
  pivot_wider(names_from = q, values_from = value) %>%
  dplyr::rename(countrycode = country) %>%
  dplyr::mutate(country = recode(countrycode,
    AGO = "Angola",
    BDI = "Burundi",
    BEN = "Benin",
    BFA = "Burkina Faso",
    CAF = "C. African Republic",
    CIV = "Cote D'Ivoire",
    CMR = "Cameroon",
    COD = "DR Congo",
    COG = "Republic of Congo",
    ETH = "Ethiopia",
    GHA = "Ghana",
    GNB = "Guinea Bissau",
    KEN = "Kenya",
    LBR = "Liberia",
    MLI = "Mali",
    MOZ = "Mozambique",
    MRT = "Mauritania",
    MWI = "Malawi",
    NER = "Niger",
    NGA = "Nigeria",
    RWA = "Rwanda",
    SDN = "Sudan",
    SEN = "Senegal",
    SLE = "Sierra Leone",
    SOM = "Somalia",
    SSD = "South Sudan",
    SWZ = "Eswatini",
    TCD = "Chad",
    TGO = "Togo",
    TZA = "Tanzania",
    UGA = "Uganda",
    ZAF = "South Africa",
    ZMB = "Zambia",
    ZWE = "Zimbabwe"
  )) %>%
  dplyr::mutate(country = ifelse(swap_current_who, paste0(country, "*"), country)) %>%
  dplyr::filter(source != "UNICEF") %>%
  dplyr::mutate(
    data_source = dplyr::case_when(
      source == "current" ~ "JHU_2015-19",
      source == "lancet" ~ "JHU_2010-16",
      source == "WHO" ~ "WHO_2015-19"
    ),
    years = dplyr::case_when(
      source == "current" ~ "2015-2019",
      source == "lancet" ~ "2010-2016",
      source == "WHO" ~ "2015-2019"
    )
  )

cases <- dplyr::filter(datlong, type == "cases")
rates <- dplyr::filter(datlong, type == "rates") %>%
  dplyr::mutate(mean10K = mean * 10000)
rateRatio <- dplyr::filter(datlong, type == "rates" & source %in% c("current", "lancet")) %>%
  dplyr::select(country, source, mean) %>%
  pivot_wider(names_from = source, values_from = mean) %>%
  dplyr::mutate(ratio = current / lancet) %>%
  dplyr::mutate(changes = dplyr::case_when(
    ratio > 1 ~ "increased incidence",
    ratio == 1 ~ "no updated estimates",
    ratio < 1 ~ "decreased incidence"
  ))
```

```{r write_out}
readr::write_csv(dplyr::select(datlong, -swap_current_who, -source), "prelim_estimates_minireport.csv")
```

```{r figsettings}
pal <- diverging_hcl(4, palette = "Purple Green")
names(pal) <- c("JHU_2015-19", "JHU_2010-16", "UNICEF", "WHO_2015-19")
w <- 7
h <- 5
```

In this report, we present preliminary nationwide estimates of mean annual incidence of suspected cholera from 2015-2019 for countries in sub-Saharan Africa. We compare our "JHU_2015_2019" estimates to three other sources of information:

* Mean annual incidence of suspected cholera from 2010-2016 ("JHU_2010-16") (Lessler and Moore et al. 2018 _Lancet_)
* Mean of WHO annual cholera reports from 2015-2019 ("WHO_2015-19")
<!-- * Mean of annual UNICEF reports according to the WCAR and ESAR cholera platforms, across all available data from 2016 onward ("UNICEF"). Note that this source was not completely up-to-date in our database at the time that this report was compiled. -->

Exceptions:

* Preliminary model estimates from some countries did not pass internal quality checks in several countries, so 2015-2019 WHO reports are presented instead as the current estimates. In these circumstances, we assumed that Poisson-distributed variability represented 95% confidence intervals. These countries include: Ghana, Mozambique, Sudan, South Sudan, Eswatini, Tanzania, Zambia, and Zimbabwe.
* Several countries in sub-Saharan Africa are not included in this report because there were no reported cholera data in the GTFCC cholera database during the 2015-2019 period. These countries include: Botswana, Djibouti, Eritrea, Gabon, the Gambia, Equatorial Guinea, Lesotho, Madagascar, and Namibia.

# Figures

```{r caseplot, fig.width=5, fig.height=7, fig.cap="Mean annual cholera incident cases, 2010-2016 estimates versus preliminary 2015-2019 estimates. The difference between 2010-16 and 2015-19 estimates is shown with a grey line. Mean annual reports to WHO from 2015-2019 are displayed for reference. WHO reports were used for JHU_2015-19 estimates for countries marked with '*'. "}
plt_c <- ggplot(cases, aes(y = country)) +
  geom_point(aes(x = mean, colour = data_source, group = data_source), alpha = 0.8, size = 2) +
  geom_path(data = dplyr::filter(cases, source %in% c("lancet", "current")), aes(y = country, x = mean), colour = "grey60") +
  scale_x_sqrt("Cases", breaks = c(0, 100, 1000, 5000, 10000, 20000, 30000, 50000), labels = scales::comma) +
  scale_colour_manual(values = pal) +
  theme_bw() +
  theme(legend.position = "bottom", axis.title.y = element_blank(), legend.title = element_blank())

ggsave("case_comparison_minireport.png", plt_c, width = w, height = h)
plt_c
```

```{r rateplot, fig.width=5, fig.height=7, fig.cap="Mean annual cholera incidence rate, 2010-2016 estimates versus preliminary 2015-2019 estimates. The difference between 2010-16 and 2015-19 estimates is shown with a grey line. WHO reports were used for JHU_2015-19 estimates for countries marked with '*'."}
plt_r <- ggplot(rates, aes(y = country)) +
  geom_point(aes(x = mean10K, colour = data_source, group = data_source), alpha = 0.8, size = 2) +
  geom_path(aes(x = mean10K), colour = "grey60") +
  scale_x_continuous("Incidence Rate per 10K", labels = scales::comma) +
  scale_colour_manual(values = pal) +
  theme_bw() +
  theme(legend.position = "bottom", axis.title.y = element_blank(), legend.title = element_blank())

ggsave("rate_comparison_minireport.png", plt_r, width = w, height = h)
plt_r
```

```{r rrplot, fig.width=5, fig.height=7, fig.cap="Rate ratio of preliminary 2015-2019 to 2010-2016 mean annual cholera incidence estimates"}
plt_rr <- ggplot(rateRatio, aes(y = country)) +
  geom_point(aes(x = ratio, colour = changes), size = 2) +
  geom_vline(aes(xintercept = 1)) +
  scale_x_log10("Rate Ratio (current/lancet)", labels = scales::comma) +
  theme_bw() +
  theme(legend.position = "bottom", axis.title.y = element_blank(), legend.title = element_blank()) +
  guides(colour = guide_legend(nrow = 2))

ggsave("rateratio_minireport.png", plt_rr, width = w, height = h)
plt_rr
```

# Tables

```{r casetab}
dplyr::filter(datlong, type == "cases") %>%
  dplyr::mutate(source = ifelse(source == "WHO", source, "JHU")) %>%
  dplyr::select(country, source, years, mean, low, high) %>%
  dplyr::arrange(country) %>%
  kableExtra::kable(digits = 0, caption = "Mean annual incidence cases", col.names = c("Country", "Source", "Years", "Mean", "2.5%", "97.5%")) %>%
  kableExtra::kable_styling(full_width = F)
```

```{r ratetab}
dplyr::filter(datlong, type == "rates") %>%
  dplyr::mutate(source = ifelse(source == "WHO", source, "JHU")) %>%
  dplyr::select(country, source, years, mean, low, high) %>%
  dplyr::arrange(country) %>%
  dplyr::mutate(mean = mean * 10, low = low * 10, high = high * 10) %>%
  kableExtra::kable(caption = "Mean annual incidence rate per 100,000", col.names = c("Country", "Source", "Years", "Mean", "2.5%", "97.5%")) %>%
  kableExtra::kable_styling(full_width = F)
```

# Methods

## 2015-2019 JHU mean annual incidence estimates
We used suspected cholera surveillance reports at different administrative unit levels from the GTFCC cholera database to estimate the mean annual incidence of suspected cholera from 2015-2019 by 20 km x 20 km grid cells in a spatial Bayesian hierarchical modeling framework. The underlying cholera reports come from diverse sources ranging from weekly situational reports, NGO and outbreak reports, peer-reviewed literature, and the WHO. Multiple reports from different sources covering the same outbreak were considered to be independent observations of the same underlying process, thus contributing to measurement error in the reported case counts.

Countries were modeled separately, and model structures varied slightly between country to achieve better fits. Reported case counts were modeled with a Poisson distribution, and model terms include: a gridded covariate of distance to water, a spatial smoothing term similar to a conditional autoregressive (CAR) term ([Datta et al. (2019)](https://projecteuclid.org/journals/bayesian-analysis/volume-14/issue-4/Spatial-Disease-Mapping-Using-Directed-Acyclic-Graph-Auto-Regressive-DAGAR/10.1214/19-BA1177.full)), and a yearly random effect.

Model estimation was implemented with a Markov Chain Monte Carlo procedure in RStan with 4 chains and 2000 iterations (1000 final posterior draws). Case counts were summed for all grid cells in the country to develop a set of posterior estimates at the country level. Incidence rate was calculated as country case counts divided by population, and population estimates were derived from the UN World Population Prospects.

## 2010-2016 JHU mean annual incidence estimates
These estimates match the data reported in [Lessler and Moore et al. (2018)](https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(17)33050-7/fulltext).

## WHO reference data
These country-level reports are taken from the WHO annual cholera reports published each year in the WER Bulletin. We calculated the mean annual incidence across 2015-2019 as a point of comparison for the new mean annual incidence estimates. Poisson-distributed variability was used to produce 95% CIs for WHO estimates.

<!-- ## UNICEF reference data
These country-level reports are taken from the UNICEF West and Central Africa region (WCAR) and East and Southern Africa region (ESAR) Cholera Plateforme. Data entry for this source is currently in progress in the GTFCC cholera database, so  this may not be representative of all cases reported to UNICEF in a given country. We calculated the mean annual incidence for all years of available data, which varied from 2013-2020 for WCAR countries and 2017-2020 for ESAR countries. -->

For questions contact Elizabeth Lee at elizabeth.c.lee@jhu.edu
