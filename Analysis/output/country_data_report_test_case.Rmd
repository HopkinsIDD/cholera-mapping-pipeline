---
title: "Country data report"
output: html_document
params:
  cholera_directory: "C:/IDD/Cholera/cholera-mapping-pipeline/Analysis/output"
  config_filename: "C:/IDD/Cholera/cholera-mapping-pipeline/Analysis/R/test1_config.yml"
  drop_nodata_years: TRUE
  nrows: 10
  ncols: 10
  data_type: "Grid data"
  oc_type: "Multiple OCs"
  polygon_type: "Fake polygons"
  polygon_coverage: 0.9
  randomize: TRUE
  ncovariates: 3
  single_year_run: "no"
  iteration: 1000
  nonspatial: c(FALSE, FALSE,FALSE)
  nontemporal: c(TRUE, TRUE,TRUE)
  spatially_smooth: c(TRUE, TRUE,TRUE)
  temporally_smooth: c(FALSE, FALSE,FALSE)
  polygonal: c(TRUE, TRUE,TRUE,)
  radiating: c(FALSE,  FALSE,TRUE)
  constant: c(TRUE,FALSE,FALSE)
  Data_simulation_covariates: c(TRUE,TRUE,TRUE)
  Model_covariates: c(TRUE,TRUE,FALSE)
  Observations_with_inconsistent_data: "no"
  Loc_with_inconsistent_data: "no"
  Cov_data_simulation_filename: "C:/IDD/Cholera/cholera-mapping-pipeline/Analysis/output/test_case_1_data_simulation_covariates.rdata"
---

```{r setup, include=FALSE, dev="CairoPNG"}
knitr::opts_chunk$set(
  echo = FALSE,
  dev="CairoPNG",
  error = FALSE,
  fig.align = "center",
  message = TRUE,
  warning = TRUE
)
library(stringr)
library(dplyr)
library(magrittr)
library(purrr)
library(readr)
library(ggplot2)
library(kableExtra)
library(taxdat)
library(sf)
library(raster)
library(stars)
library(taxdat)
sf::sf_use_s2(FALSE)
chooseCRANmirror(ind = 77)

if (!("params" %in% ls())) {
  params <- list(
    cholera_directory = "/home/app/cmp/",
    config_filename = "/home/app/cmp/Analysis/R/test_config.yml",
    drop_nodata_years = TRUE,
    ncols=10,
    nrows=10,
    data_type="Grid data",
    oc_type="Multiple OCs",
    polygon_type="Fake polygons",
    grid_coverage_type="90%",
    randomize="TRUE",
    ncovariates=2,
    single_year_run= "no",
    iteration=10000,
    nonspatial = c(FALSE, FALSE),
    nontemporal = c(FALSE, FALSE),
    spatially_smooth = c(TRUE, FALSE),
    temporally_smooth = c(FALSE, FALSE),
    polygonal = c(TRUE, TRUE),
    radiating = c(FALSE,  FALSE),
    constant=c(FALSE,FALSE),
    Data_simulation_covariates=c(TRUE,TRUE),
    Model_covariates=c(TRUE,TRUE),
    Observations_with_inconsistent_data="no",
    Loc_with_inconsistent_data="no"
  )
}

package_list <- c(
  "fasterize",
  "remotes",
  "rgeoboundaries"
)

for (package in package_list) {
  if (!require(package = package, character.only = T)) {
    if (package == "rgeoboundaries"){
      try({
        remotes::install_gitlab("dickoa/rgeoboundaries")
        remotes::install_github("wmgeolab/rgeoboundaries")
      })
    }else{
      install.packages(pkgs = package)
      library(package = package, character.only = T)
    }
  }
}

#Figure Caption Numbering,
capFigNo = 1
#Function to add the Figure Number
capFig = function(x){
    x = paste0("Figure ",capFigNo,". ",x)
    capFigNo <<- capFigNo + 1
    x
}
cache<-new.env()


```

# Mapping results summary for `r params$config_filename`

``` {r echo=FALSE}
 params_table=data.frame(do.call(rbind,params))

 row.names(params_table)=c(
  "config_filename",
  "cholera_directory",
  "drop_nodata_years",
  "Grid by rows",
  "Grid by cols",
  "Data",
  "OC",
  "Polygon",
  "Proportion of grids observed",
  "Randomize",
  "Number of covariates",
  "Single_year_run",
  "Iteration",
  "\u00A0\u00A0\u00A0Spatially-varied layers",
  "\u00A0\u00A0\u00A0Temporally-varied layers",
  "\u00A0\u00A0\u00A0Spatially smoothed",
  "\u00A0\u00A0\u00A0Temporally smoothed",
  "\u00A0\u00A0\u00A0Polygonal layer",
  "\u00A0\u00A0\u00A0Radiating layer",
  "Constant",
  "Data_simulation_covariates",
  "Model_covariates",
  "Locations with inconsistent data\n (compared to the country level)",
  "Loc with inconsistent data",
  "Cov_data_simulation_filename"
)

 data.frame(parameter=rownames(params_table)[c(1:11,23)],params_table[c(1:11,23),1])%>%
  kableExtra::kable(col.names = c("Parameter","Values"),
                    caption = "Table 1. Parameters")%>%
    kableExtra::kable_styling(bootstrap_options = c("striped"))
```

``` {r echo=FALSE}
  covar=data.frame(t(params_table[c(14:19,21,22),]))
  rownames(covar)=paste("Covariate",1:ncol(params_table))
  rownames(covar)[1]="Population"
  covar_table=covar%>%
  kableExtra::kable(col.names = c(
  "Spatially-varied layers",
  "Temporally-varied layers",
  "Spatially smoothed",
  "Temporally smoothed",
  "Polygonal layer",
  "Radiating layer",
  "Data simulation covariates",
  "Model covariates"),
  caption = "Table 2. Covariates")%>%
    kableExtra::kable_styling(bootstrap_options = c("striped"))


  if(stringr::str_detect(params$oc_type,"Multiple test observations")){
     covar=data.frame(t(params_table[c(14:19,21,22),]))
  rownames(covar)=paste("Covariate",1:ncol(params_table))
  rownames(covar)[1]="Population"
  covar_table=covar%>%
  kableExtra::kable(col.names = c(
  "Spatially-varied layers",
  "Temporally-varied layers",
  "Spatially smoothed",
  "Temporally smoothed",
  "Polygonal layer",
  "Radiating layer",
  "Data simulation covariates",
  "Model covariates"),
  caption = "Table 2. Covariates")%>%
    kableExtra::kable_styling(bootstrap_options = c("striped"))

   observation_groups=nrow(covar)/params$ncovariates
   rownames(covar)[seq(1,nrow(covar)+1-params$ncovariates,params$ncovariates)]=paste("Population",1:observation_groups)
   rownames(covar)[-seq(1,nrow(covar)+1-params$ncovariates,params$ncovariates)]=paste(paste("Covariate",2:params$ncovariates),paste0("G",1:observation_groups))
   covar_table=covar%>%
     kableExtra::kable(
       col.names = c(
  "Spatially-varied layers",
  "Temporally-varied layers",
  "Spatially smoothed",
  "Temporally smoothed",
  "Polygonal layer",
  "Radiating layer",
  "Data simulation covariates",
  "Model covariates"),
  caption = "Table 2. Covariates"
     )%>%
     kableExtra::kable_styling(bootstrap_options = c("striped"))

#group index for row headers for different test observations
   group_index=data.frame(matrix(ncol=observation_groups,nrow=1,data = c(rep(params$ncovariates,observation_groups))))
   colnames(group_index)=paste("Test observations",1:observation_groups)
   covar_table%>%
     group_rows(index = group_index)
  } else{
      covar=data.frame(t(params_table[c(14:19,21,22),]))
  rownames(covar)=paste("Covariate",1:ncol(params_table))
  rownames(covar)[1]="Population"
  covar%>%
  kableExtra::kable(col.names = c(
  "Spatially-varied layers",
  "Temporally-varied layers",
  "Spatially smoothed",
  "Temporally smoothed",
  "Polygonal layer",
  "Radiating layer",
  "Data simulation covariates",
  "Model covariates"),
  caption = "Table 2. Covariates")%>%
    kableExtra::kable_styling(bootstrap_options = c("striped"))

  }
```

## Cholera input data
**Table 1. Data used within the model:**
```{r echo = FALSE}
taxdat::table_observation_summary(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

**Table 2. Data dropped from the model:**
```{r echo=FALSE}
taxdat::table_observation_summary(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

```{r disjoint set sf cases, message=FALSE}
# aggregate_observed_polygon_cases_disjoint_aggregated(name="observed_polygon_cases_disjoint_aggregated",config=params$config,cholera_directory=params$cholera_directory,cache=cache)
# disjoint_set_sf_cases <- cache[["observed_polygon_cases_disjoint_aggregated"]]
```

**Cases by time:**
```{r rawobsmap, fig.height=5, fig.width=10, fig.cap=capFig("Observed case counts by time adjusted for time fraction cases/year")}
taxdat::plot_observed_cases_polygon_raw(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

**Area adjusted cases by time:**
```{r areadjustedmap, fig.height=5, fig.width=10, fig.cap=capFig("Area adjusted average observed case counts by time adjusted for time fraction cases/(year * kilometer)")}
taxdat::plot_area_adjusted_observed_cases(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

**Cases unique location periods:**
```{r obsmap, fig.height=5, fig.width=10, fig.cap=capFig("Number of observations by unique observed location periods.")}
taxdat::plot_raw_observations(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

## Covariates

#### Population
**Population raster by time slices:**
```{r pop, fig.height=5, fig.width=10, fig.cap=capFig("Population density")}
taxdat::plot_time_varying_pop_raster(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
```

**Table 3. Population by admin level:**
```{r echo = FALSE}
warning("Removed this plot for now")
# taxdat::plot_pop_by_admin(cache=cache,cholera_directory=params$cholera_directory,config=params$config)
```

#### Other covariates
**Covariate rasters:**
```{r covars, fig.height=5, fig.width=10, fig.cap=capFig("Covariate rasters")}
taxdat::plot_raster_covariates(cache=cache,cholera_directory=params$cholera_directory,config=params$config)
```

### GAM Input
**Observations input for the GAM model:**
```{r gam input of cases,fig.height=5, fig.width=10, fig.cap=capFig("Observations input for the GAM model (cases)")}
taxdat::plot_gam_fit_input_cases(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

```{r gam input of rates,fig.height=5, fig.width=10, fig.cap=capFig("Observations input of the GAM model (rates)")}
taxdat::plot_gam_fit_input_rates(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

### GAM Output
**Observations output of the GAM model:**
```{r gam output of cases,fig.height=5, fig.width=10, fig.cap=capFig("Observations output for the GAM model (cases)")}
taxdat::plot_gam_fit_output_cases(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

```{r gam output of rates,fig.height=5, fig.width=10, fig.cap=capFig("Observations output for the GAM model (rates)")}
taxdat::plot_gam_fit_output_rates(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

## Output maps

```{r importcase}
get_dropped_years(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
if(length(cache[["dropped_years"]]) == 0){
  message("All modeled years are represented by OCs.")
} else {
  message(paste(paste(cache[["dropped_years"]], collapse = ", "), "are not represented in OCs"))
  if(params$drop_nodata_years){
    message(paste("Dropping", paste(cache[["dropped_years"]], collapse = ", "), "from case_raster"))
    ## case_raster <- dplyr::filter(case_raster, !(t %in% drop_year_ix))
  }
}
```

#### Modeled cases
**Modeled cases raster by time slices:**
```{r caserast, fig.cap=capFig("Modeled cases"), fig.height=5, fig.width=10}
plot_disaggregated_modeled_cases_time_varying(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Table 4. Modeled cases by admin level and time:**
```{r echo = FALSE}
warning("Skipping this one for now, since it should be done via sfrac")
# table_cases_by_admin(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
```

#### Modeled incidence rates
**Modeled incidence rates raster by time slices:**
```{r raterast, fig.cap=capFig("Modeled rates by time"), fig.height=5, fig.width=10}
plot_modeled_rates_time_varying(
  config = params$config,
  cache = cache,
  cholera_directory = params$cholera_directory
)
```

**Table 5. Modeled population-weighted incidence rates by admin level and time:**
```{r echo = FALSE}
warning("Skipping this one since it should be done via sfrac")
# plot_incidence_by_admin(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
```

### Validation

**Actual observations versus modeled cases scatter plot:**

```{r datafidelity1, fig.cap=capFig("Observations vs. modeled cases"), fig.height=10, fig.width=10}
plot_model_fidelity_tfrac_adjusted(
  config = params$config,
  cache = cache,
  cholera_directory = params$cholera_directory
)
```

```{r datafidelity3, fig.cap=capFig("Observations vs. modeled cases (tfrac adjusted)"), fig.height=15, fig.width=10}
warning("Took this one out because it's a bit harder and I was rushing")
# plot_model_fidelity_tfrac_adjusted_by_year(data_fidelity = cache[["data_fidelity"]],case_raster = cache[["case_raster"]],render = T)
```

```{r datafidelity4, fig.cap=capFig("Observations vs. modeled cases"), fig.height=8, fig.width=10}
warning("Took this one out because it was identical to the adjusted figure. Must be missing something")
# plot_model_fidelity_tfrac_unadjusted(data_fidelity = cache[["data_fidelity"]],case_raster = cache[["case_raster"]],render = T)
```

```{r true and modeled gridded cases, fig.cap="Figure 7. Observations vs. modeled gridded cases", fig.height=6, fig.width=6}
warning("Disabled this for now.")
#  covar_cube <- stan_input$covar_cube
#  covar_cube[,paste("cases", "chain", seq_len(ncol(cases_chains)), sep = "_")] <- cases_chains
#  modeled_grid_case<-covar_cube#%>%select(x,y,t,cases_chain_1,cases_chain_2,cases_chain_3,cases_chain_4)
#  modeled_grid_case$geometry <- sf::st_as_sfc(modeled_grid_case$geometry)
#  modeled_grid_case <- sf::st_as_sf(modeled_grid_case)
#
#  true_grid_case<-readRDS(config$test_metadata$test_true_grid_case_filename)#%>%select(row,col,cases,t)#%>%rename(x=row,y=col)
#
#  wide_modeled_true_grid_cases<-data.frame(sf::st_join(st_centroid(true_grid_case),modeled_grid_case) %>% dplyr::filter(t.x == t.y))%>%select(x,y,cases_chain_1,cases_chain_2,cases_chain_3,cases_chain_4,cases)
#
#  long_modeled_grid_case <- data.frame(melt(wide_modeled_true_grid_cases, id.vars = c("x","y","cases"), variable.name = "chains"))%>%rename("modeled grid cases"=value,"true grid cases"=cases)
#
#  plt <- ggplot2::ggplot(long_modeled_grid_case) +
#       ggplot2::geom_point(ggplot2::aes(y = `modeled grid cases`, x = `true grid cases`, col = chains)) +
#       ggplot2::geom_abline(intercept = 0, slope = 1) +
#       ggplot2::coord_fixed(ratio = 1, xlim = c(0, max(long_modeled_grid_case[,3])), ylim = c(0, max(long_modeled_grid_case[,5]))) +
#       ggplot2::theme_bw()
#  plt

```

**Stan trace plots:**
```{r traceplots, fig.height=8, fig.width=10, fig.cap=capFig("Stan trace plots")}
taxdat::plot_stan_parameter_traceplot(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Parameter posteriors:**
```{r params, fig.height=6, fig.width=6, fig.cap=capFig("Parameter posteriors")}
taxdat::plot_stan_parameter_violin(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Gelman-Rubin Rhat:**
```{r rhat, fig.height=5, fig.width=10, fig.cap=capFig("Gelman-Rubin Rhat")}
plot_rhat(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Table 6. Observed and estimates of WHO annual cholera reports:**
```{r WHO output, fig.height=510, fig.width=10, fig.cap = "comparison with WHO Output"}
warning("Skipping this figure for now since I'm not sure what it means for new pipeline")
# plot_WHOcomparison_table(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

**Table 7. Estimated cases by chain and time slice:**
```{r cases_chain_table, fig.width=10, fig.cap = "Sum of grid cases by chain and year"}
warning("Coming back to this later")
# plot_modeled_cases_by_chain_time (config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

```{r full country modeled cases, fig.cap = "comparison with WHO Output"}
  warning("This is a weird thing to print")
  total_cases <- sum(cache[["grid_cases_mean"]])
  print(paste("There are",format(round(total_cases), big.mark=","),"total cases"))
```
