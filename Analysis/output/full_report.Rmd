---
title: ""
output: html_document
params:
  cholera_directory: "../../"
  config_directory: "../configs/2015_2019"
---
```{r setup, include=FALSE, dev="CairoPNG"}
knitr::opts_chunk$set(inlude = FALSE, dev="CairoPNG")
library(stringr)
library(dplyr)
library(magrittr)
library(purrr)
library(readr)
library(ggplot2)
library(kableExtra)
library(RColorBrewer)
library(sf)

source(str_c(params$cholera_directory, "/Analysis/output/model_run_report_helpers.R"))
source(str_c(params$cholera_directory,"/packages/taxdat/R/readData.R"))
```

```{r datapull, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
max_pull <- 2
all_configs <- list.files(params$config_directory,full.names=TRUE)
all_locations <- str_extract(all_configs, "(?<=g_)[A-Z]{3}(?=_)")
all_times <- unique(str_extract(all_configs, "(?<=_)[0-9]{4}_[0-9]{4}(?=\\.)"))
if(length(all_times) > 1){
  stop("This report was not intended to compile runs from different time ranges")
}

sf_cases_resized <- list()
sf_grid <- list()
pull <- 0
for(config_filename in all_configs){
  pull <- pull + 1
  if(pull >= max_pull){break}
  config <- yaml::read_yaml(config_filename)
  file_names <- getFilenames(config, params$cholera_directory)
  if(all(file.exists(file_names))){
    stan_input <- read_file_of_type(file_names[['stan_input']], "stan_input")
    stan_output <- rstan::extract(read_file_of_type(file_names[['stan_output']], "model.rand"))
    
    stan_input$sf_grid <- stan_input$sf_grid %>% select(t,id)
    stan_input$sf_grid$modeled_cases <- apply(stan_output$grid_cases, 2, mean)
    stan_input$sf_grid$modeled_rate <- apply(exp(stan_output$log_lambda), 2, mean)
  
    stan_input$sf_cases_resized <- dplyr::rename(
      dplyr::select(stan_input$sf_cases_resized, location_name, OC_UID,TL,TR,suspected_cases),
      observed_cases = suspected_cases
    )
    stan_input$sf_cases_resized$modeled_cases <- apply(stan_output$modeled_cases,2,mean)
  
    if("list" %in% class(sf_grid)){
      sf_grid <- stan_input$sf_grid
    } else {
      sf_grid <- rbind(sf_grid, stan_input$sf_grid)
    }
    if("list" %in% class(sf_cases_resized)){
      sf_cases_resized <- stan_input$sf_cases_resized
    } else {
      sf_cases_resized <- rbind(sf_cases_resized, stan_input$sf_cases_resized)
    }
  }
}

# disjoint_set_sf_cases_observed <- get_disjoint_set_sf_cases(dplyr::mutate(sf_cases_resized,attributes.fields.suspected_cases = observed_cases))
#disjoint_set_sf_cases_modeled <- get_disjoint_set_sf_cases(dplyr::mutate(sf_cases_resized,attributes.fields.suspected_cases = modeled_cases))
#if(!all(disjoint_set_sf_cases_observed$attributes.location_period_id == disjoint_set_sf_cases_modeled$attributes.location_period_id,na.rm=TRUE)){
#  stop("Expected disjoint_set_sf_cases to be in the same order")
#}
#if(!all(disjoint_set_sf_cases_observed$set == disjoint_set_sf_cases_modeled$set,na.rm=TRUE)){
#  stop("Expected disjoint_set_sf_cases to have the same sets")
#}
#disjoint_set_sf_cases <- disjoint_set_sf_cases_observed[,c("set","attributes.location_period_id")]
#
#disjoint_set_sf_cases$observed_cases <- disjoint_set_sf_cases_observed$cases
#disjoint_set_sf_cases$observed_area_adjusted_cases <- disjoint_set_sf_cases_observed$area_adjusted_cases
#disjoint_set_sf_cases$observed_variance <- disjoint_set_sf_cases_observed$variance
#disjoint_set_sf_cases$observed_number_observations <- disjoint_set_sf_cases_observed$observations
#
#disjoint_set_sf_cases$modeled_cases <- disjoint_set_sf_cases_modeled$cases
#disjoint_set_sf_cases$modeled_area_adjusted_cases <- disjoint_set_sf_cases_modeled$area_adjusted_cases
#disjoint_set_sf_cases$modeled_variance <- disjoint_set_sf_cases_modeled$variance
#disjoint_set_sf_cases$modeled_number_observations <- disjoint_set_sf_cases_modeled$observations
#disjoint_set_sf_cases$error_cases <- (disjoint_set_sf_cases$modeled_cases - disjoint_set_sf_cases$observed_cases)
```


# Mapping results summary for `r paste(all_locations, collapse =', ')` and period `r all_times`

```{r grdioutcase, fig.cap="Plot Grid Output Cases", echo=FALSE, warning=FALSE,message=FALSE, fig.fullwidth=TRUE}
# plot_cases(sf_grid,"modeled_cases","t",render=TRUE, plot_border = FALSE)
```

```{r gridoutrate, fig.cap="Plot Grid Output Rates", echo=FALSE, warning=FALSE,message=FALSE, fig.fullwidth=TRUE}
# plot_rates(sf_grid,"modeled_rate","t", render=TRUE, plot_border = FALSE)
```

```{r gridoutcaselog, fig.cap="Plot Grid Output Cases with log transform", echo=FALSE, warning=FALSE,message=FALSE, fig.fullwidth=TRUE}
plot_cases(sf_grid,"modeled_cases","t",render=TRUE, plot_border = FALSE, use_log = TRUE)
```

```{r gridoutratelog, fig.caps = "Plot Grid Output Rates with log transform", echo=FALSE, warning=FALSE,message=FALSE, fig.fullwidth=TRUE}
# plot_rates(sf_grid,"modeled_rate","t", render=TRUE, plot_border = FALSE, use_log = TRUE)
```

```{r obsin, fig.cap="Plot Observation Cases Input", echo=FALSE, warning=FALSE,message=FALSE}, fig.fullwidth=TRUE
# plot_cases(disjoint_set_sf_cases,"modeled_cases","set", render=TRUE)
```

```{r obsout, fig.cap="Plot Observation Cases Output", echo=FALSE, warning=FALSE,message=FALSE, fig.fullwidth=TRUE}
# plot_cases(disjoint_set_sf_cases,"observed_cases","set", render=TRUE)
```

```{r obserr, fig.cap="Plot Observation Cases Error", echo=FALSE, warning=FALSE,message=FALSE, fig.fullwidth=TRUE}
# plot_cases(disjoint_set_sf_cases,"error_cases","set", render=TRUE)
```
