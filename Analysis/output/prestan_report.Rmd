---
title: "prestan_report"
output: 
  html_document:
    toc: true
    toc_float: true
params:
  cholera_directory: "C:/Users/zheng/Cholera/cmp"
  cholera_config_directory: "/cholera-configs/no_covariate_production_2016_2020/2016_2020_country/"
  cholera_data_dir: "/cholera-mapping-output/no_covar/"
  start_year: 2016
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
```

```{r load data, echo=FALSE}
#load config:
config_files<-list.files(paste0(params$cholera_directory,params$cholera_config_directory))
file_names<-data.frame()
for (idx in 1:length(config_files)){
  config_tmp<-yaml::read_yaml(paste0(params$cholera_directory,params$cholera_config_directory,config_files[idx]))
  tmp<-data.frame(file_name=config_tmp$file_names)
  file_names<-rbind(file_names,tmp)
}

# Find and load the model output 
fns <- list.files(paste0(params$cholera_directory,params$cholera_data_dir), full.names = FALSE, recursive=FALSE)

#check if all files are in the data folder
if(all(file_names$file_name %in% fns)){
  print("Great job! All files are in the data folder")
}else{
  print(file_names$file_name[!file_names$file_name%in%fns])
}

```

```{r max_tfrac_plot, echo=FALSE}
# output files
country_list <- unique(stringr::str_extract(fns, "^[A-Z]{3}"))
country_list <- country_list[!is.na(country_list)]
if(params$start_year == 2016){country_list <- country_list[country_list != "GMB"]}
fns_filtered <- fns[grepl("stan_input.rdata$", fns)]
fns_filtered <- fns_filtered[grepl(as.character(params$start_year), fns_filtered)]

# Loop through all the files
tfrac_table <- tibble::tibble(iso = as.character(),  year = as.numeric(), max_tfrac = as.numeric(), zero_case = as.logical())
NA_zero_table <- tibble::tibble(iso = as.character(),  year = as.numeric(), category = as.character())

for(country_code in country_list){
  load(paste(params$cholera_directory,params$cholera_data_dir, fns_filtered[grepl(country_code, fns_filtered)], sep = "/"))
  
  tmp <- stan_input$sf_cases_resized %>%
    sf::st_drop_geometry() %>%
    mutate(idx = 1:n(), nyears = lubridate::year(TR) - lubridate::year(TL) + 1)
  tmp <- as.data.frame(lapply(tmp, rep, tmp$nyears)) 
  tmp <- tmp %>%
    group_by(idx) %>%
    mutate(year = lubridate::year(TL) + (1:n()) - 1) %>%
    rename(suspected_cases = attributes.fields.suspected_cases)
  tmp$tfrac <- stan_input$stan_data$tfrac

  tfrac_table_tmp <- tmp %>%
    group_by(year) %>%
    summarise(max_tfrac = max(tfrac), iso = country_code, zero_case = (sum(suspected_cases) == 0))

  # the table
  for(i in (params$start_year):(params$start_year+4)){
    if(nrow(tfrac_table_tmp[tfrac_table_tmp$year == i & tfrac_table_tmp$iso == country_code, ]) == 0){
      NA_zero_table <- NA_zero_table %>%
        add_row(iso = country_code, year = i, category = "NA-tfrac")
    }else if(tfrac_table_tmp[tfrac_table_tmp$year == i & tfrac_table_tmp$iso == country_code, ]$max_tfrac == 0){
      NA_zero_table <- NA_zero_table %>%
        add_row(iso = country_code, year = i, category = "zero-tfrac")
    }
  }
  

  if(nrow(tfrac_table_tmp) < 5){
    empty_year <- ((params$start_year):(params$start_year+4))[!((params$start_year):(params$start_year+4)) %in% tfrac_table_tmp$year]
    tfrac_table_tmp <- tfrac_table_tmp %>% add_row(iso = country_code, year = empty_year, max_tfrac = 0, zero_case = FALSE)
  }

  tfrac_table <- rbind(tfrac_table, tfrac_table_tmp)
}

# Plotting
plt <- tfrac_table %>%
  ggplot(aes(x=year, y=max_tfrac)) +
  geom_bar(stat="identity", fill="lightblue") +
  geom_text(aes(label = ifelse(zero_case, as.character("zero-case"), "")), fontface = "bold", size = 1.0) + 
  theme_minimal() + 
  facet_wrap( ~ iso, scales = "free", ncol = 5) + 
  scale_x_continuous(breaks=seq(params$start_year,params$start_year+4,1)) + 
  scale_y_continuous(limits=c(0, 1)) + 
  theme_minimal()
fig_height <- length(country_list) 
pdf(paste0(params$cholera_directory,"/Analysis/output/", 
          as.character(params$start_year), "-", as.character(params$start_year+4), "_max_tfrac_barplot.pdf"), 
    height = fig_height/2, width = 10)
plt
dev.off()

readr::write_csv(NA_zero_table, paste0(params$cholera_directory,"/Analysis/output/", 
                                      as.character(params$start_year), "-", as.character(params$start_year+4), "_max_tfrac_NA_zero_table.csv"))
```
