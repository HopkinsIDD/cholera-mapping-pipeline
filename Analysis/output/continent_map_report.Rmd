---
title: "Continent Map Report"
output:
  html_document:
    toc: true
    toc_float: true
params:
  cholera_directory: "~/code/cholera-mapping-pipeline/"
  config_directory: "Analysis/configs/2015_2019_full_base/"
  output_dir: "Analysis/output/2015_2019_full_base/"
  max_countries: Inf
---
```{r setup, include=FALSE, dev="CairoPNG"}
library(stringr)
library(dplyr)
library(magrittr)
library(purrr)
library(readr)
library(ggplot2)
library(kableExtra)
library(RColorBrewer)
library(MCMCvis)
library(sf)
library(sp)
library(abind)
library(taxdat)

if (! "params" %in% ls()) {
  params <- list(
    cholera_directory = "~/git/cholera-mapping-pipeline/",
    config_directory = "~/git/cholera-configs/Dec_2021_runs",
    output_dir = "~/git/cholera-mapping-output/continent_map",
    max_countries = Inf
  )
}

options(bitmapType = 'cairo')
knitr::opts_chunk$set(
  echo = FALSE,
  dev = "CairoPNG",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  cache.lazy = F,
  error = TRUE,
  bitmapType = "cairo")
```

```{r dir_settings}
dir.create(params$output_dir, showWarnings = FALSE)
```

```{r datapull}
all_files <- list.files(params$config_directory, full.names = TRUE, recursive=TRUE)
all_configs <- all_files[grepl('.yml$', all_files)]
all_locations <- stringr::str_extract(all_configs, "[A-Z]{3}")
unique_locations <- unique(all_locations)
print(all_configs)
print(all_locations)

sf_cases_resized <- list()
sf_grid <- list()
country_count <- 0
results <- NULL
full_cache <- new.env()
full_cache$case_results <- NULL
error_locations_cases <- unique_locations
for(config_filename in all_configs){
  tryCatch({
  local_cache <- new.env()
  print(config_filename)
  if(country_count >= params$max_countries){break}
  if(is.null(full_cache$case_results)) {
    taxdat:::merge_modeled_cases_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$case_results <- local_cache$modeled_cases_mean_raster
  } else {
    taxdat:::merge_modeled_cases_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$case_results <- rbind(full_cache$case_results, local_cache$modeled_cases_mean_raster)
  }
  error_locations_cases <- error_locations_cases[error_locations_cases != all_locations[all_configs == config_filename] ]
  }, error = function(e) {
    warning(paste(config_filename,"failed with message", e$message))
  })
}
taxdat:::plot_raster_with_fill("case_results", "cases", "modeled_cases_mean", full_cache)

full_cache$rate_results <- NULL
error_locations_rates <- unique_locations
for(config_filename in all_configs){
  tryCatch({
  local_cache <- new.env()
  print(config_filename)
  if(country_count >= params$max_countries){break}
  if(is.null(full_cache$rate_results)) {
    taxdat:::merge_modeled_rates_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$rate_results <- local_cache$modeled_rates_mean_raster
  } else {
    taxdat:::merge_modeled_rates_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$rate_results <- rbind(full_cache$rate_results, local_cache$modeled_rates_mean_raster)
  }
  error_locations_rates <- error_locations_rates[error_locations_rates != all_locations[all_configs == config_filename] ]
  }, error = function(e) {
    warning(paste(config_filename,"failed with message", e$message))
  })
}
taxdat:::plot_raster_with_fill("rate_results", "rates", "modeled_rates_mean", full_cache)

afr_shp <- sf::st_boundary(sf::st_read(paste(params$cholera_directory,"Layers/Africa.shp",sep='/')))

# add CRS
afr_shp <- as(afr_shp, 'Spatial')
sp::proj4string(afr_shp) <- sp::CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs")
afr_shp <- as(afr_shp, 'sf')
```

# Mapping results summary for `r paste(all_locations, collapse =', ')`

```{r makenosplit}
single_sf_grid <- sf_grid %>% dplyr::group_by(id, type) %>% dplyr::summarize(modeled = mean(modeled), geometry = geom) %>% dplyr::ungroup() %>% unique()
```

### Plot Grid Output Cases {.tabset}

#### Cases

```{r gridoutcase, fig.height=7}
taxdat::plot_map(dplyr::filter(single_sf_grid,type=='cases'),"modeled", facet_column='type', colorscale_type = 'cases', render=TRUE, plot_border = afr_shp)
```

#### Cases with log transform

```{r gridoutcaselog, fig.height=7}
taxdat::plot_map(dplyr::filter(single_sf_grid,type=='cases'),"modeled", facet_column='type', colorscale_type = 'cases', render=TRUE, plot_border = afr_shp, use_log=TRUE)
```

### Plot Grid Output Rates {.tabset}

#### Rates

```{r gridoutrate, fig.height=7}
taxdat::plot_map(dplyr::filter(single_sf_grid,type=='rate'),"modeled", facet_column='type', colorscale_type = 'rates', render=TRUE, plot_border = afr_shp)
```

#### Rates with log transform

```{r gridoutratelog, fig.height=7}
taxdat::plot_map(dplyr::filter(single_sf_grid,type=='rate'),"modeled", facet_column='type', colorscale_type = 'rates', render=TRUE, plot_border = afr_shp, use_log=TRUE)
```

```{r makechainsplit}
rm(single_sf_grid)
chain_sf_grid <- sf_grid %>% dplyr::group_by(id,chain,type) %>% dplyr::summarize(modeled = mean(modeled), geometry = geom) %>% dplyr::ungroup() %>% unique()
```

### Plot Grid Output Cases by Chain {.tabset}

#### Cases by chain

```{r chaingrdioutcase, fig.height=7}
taxdat::plot_map(dplyr::filter(chain_sf_grid,type=='cases'), "modeled", "chain", colorscale_type = 'cases', render=TRUE, plot_border = afr_shp)
```

#### Cases with log transform by chain

```{r chaingridoutcaselog, fig.height=7}
taxdat::plot_map(dplyr::filter(chain_sf_grid,type=='cases'), "modeled", "chain", colorscale_type = 'cases', render=TRUE, plot_border = afr_shp, use_log = TRUE)
```

### Plot Grid Output Rates by Chain {.tabset}

#### Rates by chain

```{r chaingridoutrate, fig.height=7}
taxdat::plot_map(dplyr::filter(chain_sf_grid,type=='rate'), "modeled", "chain", colorscale_type = 'rates', render=TRUE, plot_border = afr_shp)
```

#### Rates with log transform by chain

```{r chaingridoutratelog, fig.height=7}
taxdat::plot_map(dplyr::filter(chain_sf_grid,type=='rate'), "modeled", "chain", colorscale_type = 'rates', render=TRUE, plot_border = afr_shp, use_log = TRUE)
```

### Plot Grid Output Cases by Time {.tabset}

```{r maketimesplit}
rm(chain_sf_grid)
time_sf_grid <- sf_grid %>% dplyr::group_by(id,t,type) %>% dplyr::summarize(modeled = mean(modeled), geometry = geom) %>% dplyr::ungroup() %>% unique()
```

#### Cases by time

```{r timegrdioutcase, fig.height=7}
taxdat::plot_map(dplyr::filter(time_sf_grid,type=='cases'), "modeled", "t", colorscale_type = 'cases', render=TRUE, plot_border = afr_shp)
```

#### Cases with log transform by time

```{r timegridoutcaselog, fig.height=7}
taxdat::plot_map(dplyr::filter(time_sf_grid,type=='cases'), "modeled", "t", colorscale_type = 'cases', render=TRUE, plot_border = afr_shp, use_log = TRUE)
```

### Plot Grid Output Rates by Time {.tabset}

#### Rates by time

```{r timegridoutrate, fig.height=7}
taxdat::plot_map(dplyr::filter(time_sf_grid,type=='rate'), "modeled", "t", colorscale_type = 'rates', render=TRUE, plot_border = afr_shp)
```

#### Rates with log transform by time

```{r timegridoutratelog, fig.height=7}
taxdat::plot_map(dplyr::filter(time_sf_grid,type=='rate'), "modeled", "t", colorscale_type = 'rates', render=TRUE, plot_border = afr_shp, use_log = TRUE)
```

```{r cleantimesplit, echo=FALSE, warning=FALSE,message=FALSE}
rm(time_sf_grid)
```

### Plot Observed vs Modeled

```{r modelfit}
sf_cases_resized %>%
  ggplot2::ggplot() +
  ggplot2::geom_point(ggplot2::aes(x=modeled+1,y=observed+1,color=as.character(chain))) +
  ggplot2::scale_x_continuous(trans="log10") +
  ggplot2::scale_y_continuous(trans="log10")
```
