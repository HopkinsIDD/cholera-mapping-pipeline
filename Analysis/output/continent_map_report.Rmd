---
title: "Continent Map Report"
output:
  html_document:
    toc: true
    toc_float: true
params:
  cholera_directory: "~/code/cholera-mapping-pipeline/"
  config_directory: "Analysis/configs/2015_2019_full_base/"
  output_dir: "Analysis/output/2015_2019_full_base/"
  max_countries: Inf
---
```{r setup, include=FALSE, dev="CairoPNG"}
library(stringr)
library(dplyr)
library(magrittr)
library(purrr)
library(readr)
library(ggplot2)
library(kableExtra)
library(RColorBrewer)
library(MCMCvis)
library(sf)
library(sp)
library(abind)
library(taxdat)

if (! "params" %in% ls()) {
  params <- list(
    cholera_directory = "~/git/cholera-mapping-pipeline/",
    config_directory = "~/git/cholera-configs/Dec_2021_runs",
    output_dir = "~/git/cholera-mapping-output/continent_map",
    max_countries = Inf
  )
}

options(bitmapType = 'cairo')
knitr::opts_chunk$set(
  echo = FALSE,
  dev = "CairoPNG",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  cache.lazy = F,
  error = TRUE,
  bitmapType = "cairo")
```

```{r dir_settings}
dir.create(params$output_dir, showWarnings = FALSE)
```

```{r datapull}
all_files <- list.files(params$config_directory, full.names = TRUE, recursive=TRUE)
all_configs <- all_files[grepl('.yml$', all_files)]
all_locations <- stringr::str_extract(all_configs, "[A-Z]{3}")
unique_locations <- unique(all_locations)
print(all_configs)
print(all_locations)

sf_cases_resized <- list()
sf_grid <- list()
country_count <- 0
results <- NULL
full_cache <- new.env()
full_cache$case_results <- NULL
error_locations_cases <- unique_locations
for(config_filename in all_configs){
  tryCatch({
  local_cache <- new.env()
  print(config_filename)
  if(country_count >= params$max_countries){break}
  if(is.null(full_cache$case_results)) {
    taxdat:::merge_modeled_cases_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$case_results <- local_cache$modeled_cases_mean_raster
  } else {
    taxdat:::merge_modeled_cases_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$case_results <- rbind(full_cache$case_results, local_cache$modeled_cases_mean_raster)
  }
  error_locations_cases <- error_locations_cases[error_locations_cases != all_locations[all_configs == config_filename] ]
  }, error = function(e) {
    warning(paste(config_filename,"failed with message", e$message))
  })
}
taxdat:::plot_raster_with_fill("case_results", "cases", "modeled_cases_mean", full_cache)

full_cache$rate_results <- NULL
error_locations_rates <- unique_locations
for(config_filename in all_configs){
  tryCatch({
  local_cache <- new.env()
  print(config_filename)
  if(country_count >= params$max_countries){break}
  if(is.null(full_cache$rate_results)) {
    taxdat:::merge_modeled_rates_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$rate_results <- local_cache$modeled_rates_mean_raster
  } else {
    taxdat:::merge_modeled_rates_mean_into_raster(config_filename, local_cache, params$cholera_directory)
    full_cache$rate_results <- rbind(full_cache$rate_results, local_cache$modeled_rates_mean_raster)
  }
  error_locations_rates <- error_locations_rates[error_locations_rates != all_locations[all_configs == config_filename] ]
  }, error = function(e) {
    warning(paste(config_filename,"failed with message", e$message))
  })
}
taxdat:::plot_raster_with_fill("rate_results", "rates", "modeled_rates_mean", full_cache)

afr_shp <- sf::st_boundary(sf::st_read(paste(params$cholera_directory,"Layers/Africa.shp",sep='/')))

# add CRS
# afr_shp <- as(afr_shp, 'Spatial')
# sp::proj4string(afr_shp) <- sp::CRS("+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs")
# afr_shp <- as(afr_shp, 'sf')
# Somehow add crs to plot

## TODO:
## Aggregation:
## - Instead of iterating over each config, iterate over each country and aggregate over each config
## - Remove configs that are not for production runs
## - Diagnose errors in some country results with creating local_cache
```
