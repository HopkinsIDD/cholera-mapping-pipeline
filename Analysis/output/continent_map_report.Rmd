---
title: "Continent Map Report"
output:
  html_document:
    toc: true
    toc_float: true
params:
  cholera_directory: "/home/kaiyuezou/mapping_pipeline/9_23_dev/cholera-mapping-pipeline" #this is where the pipeline model is
  config_directory: "Analysis/configs/Gavi_reports/Dec_2021_runs" #this is where to find the configs
  output_dir: "Analysis/data/true_2021_Dec_runs_output_for_push/cholera-mapping-output" #this is where to find the model output, it doesn't need to exist in advance
  map_output_dir: "Analysis/output/continent_map" #this is where to put the continent map generated from running the code
  local_shapefile_name: "Layers/africa_self_shp/afr_g2014_2013_0.shp" #this is a local dir where Africa continent shapefile is saved, better to use GADMTools in the future
  max_countries: Inf
  dropped_years: list("ZWE" = c(2017), "ZNZ" = c(2018, 2019), "SDN" = c(2015, 2017)) #if there are years of output that we don't wanna include 
---

```{r setup, include=FALSE, dev="CairoPNG"}
# Remember to comment out the following lines when running the whole report
params <- new.env()
params$cholera_directory <- "/home/kaiyuezou/mapping_pipeline/2016_2020_no_covariate_run/cholera-mapping-pipeline" #this is where the pipeline model is
params$config_directory <- "Analysis/configs/no_covariate_production_2016_2020/2016_2020_country" #this is where to find the configs
params$output_dir <- "Analysis/data/report_finished" #this is where to find the model output, it doesn't need to exist in advance
params$map_output_dir <- "Analysis/output/continent_map" #this is where to put the continent map and shapefiles generated from running the code
params$local_shapefile_name <- "Layers/africa_self_shp/afr_g2014_2013_0.shp" #this is a local dir where Africa continent shapefile is saved, better to use GADMTools in the future
params$max_countries <- Inf
params$dropped_years <- list("ZWE" = c(2017), "ZNZ" = c(2018, 2019), "SDN" = c(2015, 2017)) #if there are years of output that we don't wanna include 
params$zero_case_years <- NULL #manually create years with zero modeled case based on our understanding of the database 
params$separate_TZA <- c("TZA_mainland", "TZA_zanzibar")
params$country_list_source <- "configs" #or "Google spreadsheet" or model output
params$modeled_years <- 2016:2020
params$tmp_dropped_countries <- c("ZAF", "GNQ", "GAB", "GMB", 
                                  "NAM", 
                                  "SEN", "ERI", "BFA", "DJI", "BWA", "MLI", "LSO", "GNB", "MDG")
# the information about dropped years or years with zero case can be drawn from the Google spreadsheet if it exists 
# to get the continent map (unionized or combined): 
# country_pattern <- paste(country, "0", sep = "_")
# shp <- GADMTools::gadm_sf_loadCountries(c(country), level = 0, basefile = file.path(datapath, "shapefiles/"))$sf

library(stringr)
library(dplyr)
library(magrittr)
library(purrr)
library(readr)
library(ggplot2)
library(kableExtra)
library(RColorBrewer)
library(MCMCvis)
library(sf)
library(sp)
library(abind)
library(taxdat)

if (! "params" %in% ls()) {
  params <- list(
    cholera_directory = "~/git/cholera-mapping-pipeline/",
    config_directory = "~/git/cholera-configs/Dec_2021_runs",
    map_output_dir = "~/git/cholera-mapping-output/continent_map",
    max_countries = Inf
  )
}

options(bitmapType = 'cairo')
knitr::opts_chunk$set(
  echo = FALSE,
  dev = "CairoPNG",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  cache = FALSE,
  cache.lazy = FALSE,
  error = TRUE,
  bitmapType = "cairo")
```

```{r dir_settings}
dir.create(params$map_output_dir, showWarnings = FALSE)
```

```{r aggregation_tmp}
### The Setup
## Initialize
final_cache <- new.env() 
final_cache$case_results <- NULL 
final_cache$rate_results <- NULL 
country_caches <- list()
country_count <- 0
complete_country <- c()
sf_cases_resized <- list()
sf_grid <- list()
results <- NULL

## Setup and get all the countries 
all_config_fns <- list.files(paste0(params$cholera_directory, "/", params$config_directory))
all_countries <- stringr::str_extract(all_config_fns, "[A-Z]{3}")
all_countries <- c(all_countries[all_countries != "TZA"], params$separate_TZA)
all_countries <- all_countries[!all_countries %in% params$tmp_dropped_countries] #drop the countries with bad output 

error_countries_cases <- all_countries
error_countries_rates <- all_countries

## From countries to certain config files 
all_configs <- new.env() 
invisible(lapply(all_countries, function(country_code){
  all_configs[[country_code]] <- paste(params$config_directory, all_config_fns[grepl(country_code, all_config_fns)], sep = "/")
}))



### Loop through each country 
for(country in all_countries) {

  ## For efficiency reason
  if(country %in% complete_country){next} 
  
    ## First the case raster 
    tryCatch({ 
      country_cache <- new.env()
      config_filename <- all_configs[[country]] 
      if(country_count >= params$max_countries){break}

      taxdat:::merge_modeled_cases_mean_into_raster(name="modeled_cases_mean_raster", config = config_filename, cache = country_cache, cholera_directory = params$cholera_directory)
      remove_dropped_years(country_cache, country, params$dropped_years, params$modeled_years) 
      continent_map_mean_across_years(cache = country_cache, sf_type = "case")

      if(is.null(final_cache$case_results)) {
        final_cache$case_results <- country_cache$modeled_cases_mean_raster_mean_across_years %>% 
          select(modeled_cases_mean_across_years) %>% 
          mutate(country_code = country)
      } else {
        final_cache$case_results <- rbind(final_cache$case_results, country_cache$modeled_cases_mean_raster_mean_across_years %>% 
                                                                      select(modeled_cases_mean_across_years) %>% 
                                                                      mutate(country_code = country)
                                          )
      } 
      # error_countries_cases <- error_countries_cases[error_countries_cases != all_countries[all_configs[[country]] == config_filename] ]
    }, 
    error = function(e){
      warning(paste(config_filename,"failed with message", e$message))
    })

    ## Then the rate raster 
    tryCatch({ 
      #country_cache <- new.env()
      config_filename <- all_configs[[country]] 
      if(country_count >= params$max_countries){break}

      taxdat:::merge_modeled_rates_mean_into_raster(name="modeled_rates_mean_raster", config = config_filename, cache = country_cache, cholera_directory = params$cholera_directory)
      remove_dropped_years(country_cache, country, params$dropped_years, params$modeled_years) 
      continent_map_mean_across_years(cache = country_cache, sf_type = "rate")

      if(is.null(final_cache$rate_results)) {
        final_cache$rate_results <- country_cache$modeled_rates_mean_raster_mean_across_years %>% 
          select(modeled_rates_mean_across_years) %>% 
          mutate(country_code = country)
      } else {
        final_cache$rate_results <- rbind(final_cache$rate_results, country_cache$modeled_rates_mean_raster_mean_across_years %>% 
                                                                      select(modeled_rates_mean_across_years) %>% 
                                                                      mutate(country_code = country)
                                          )
      } 
    
    }, 
    error = function(e){
      warning(paste(config_filename,"failed with message", e$message))
    })


  country_count <- country_count + 1 
  complete_country <- c(complete_country, country)
  
}



### Plotting -- tmp 
plt <- plot_continent_map_sf(shapefile_dir = params$map_output_dir, 
                            country_borders = TRUE, 
                            continent_sf = final_cache$case_results, 
                            sf_type = "case")
pdf(paste(params$cholera_directory, params$map_output_dir, "continent_case.pdf", sep = "/"))
plt
dev.off()

plt <- plot_continent_map_sf(shapefile_dir = params$map_output_dir, 
                            country_borders = TRUE, 
                            continent_sf = final_cache$rate_results, 
                            sf_type = "rate")
pdf(paste(params$cholera_directory, params$map_output_dir, "continent_rate.pdf", sep = "/"))
plt
dev.off()



# shapefilename <- paste(params$cholera_directory, params$local_shapefile_name, sep = "/")

# plot_case <- plot_raster_with_fill_and_continent_shp("case_results", "cases", "modeled_cases_mean", final_cache, shapefilename)
# pdf(paste(params$cholera_directory, params$map_output_dir, "continent_case.pdf", sep = "/"))
# plot_case
# dev.off()

# plot_rate <- plot_raster_with_fill_and_continent_shp("rate_results", "rates", "modeled_rates_mean", final_cache, shapefilename)
# pdf(paste(params$cholera_directory, params$map_output_dir, "continent_rate.pdf", sep = "/"))
# plot_rate
# dev.off()

```
