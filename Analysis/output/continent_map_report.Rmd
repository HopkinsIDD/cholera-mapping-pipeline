---
title: "Continent Map Report"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_float: true
params:
  cholera_directory: "/home/.../cholera-mapping-pipeline" #this is where the pipeline model is
  config_directory: "Analysis/..." #this is where to find the configs
  output_dir: "Analysis/..." #this is where to find the model output, it doesn't need to exist in advance
  map_output_dir: "Analysis/output/continent_map" #this is where to put the continent map generated from running the code
  modeled_years: c(2016:2020)
  max_countries: Inf
  dropped_years: list("ZWE" = c(2017), "ZNZ" = c(2018, 2019), "SDN" = c(2015, 2017)) #OPTIONAL: if there are years of output that we don't wanna include 
  separate_TZA: NULL #OPTIONAL: "TZA" if running the country was run as a whole, or c("TZA_mainland", "TZA_zanzibar") if separately, or NULL is not included 
  tmp_dropped_countries: c("ZAF") #OPTIONAL: drop countries that have the configs but don't have the complete output 
  args: 'continent'
---

```{r setup, include=FALSE, dev="CairoPNG"}
library(stringr)
library(dplyr)
library(magrittr)
library(purrr)
library(readr)
library(ggplot2)
library(kableExtra)
library(RColorBrewer)
library(MCMCvis)
library(sf)
library(sp)
library(abind)
library(taxdat)

if (! "params" %in% ls()) {
  params <- list(
    cholera_directory = "~/git/cholera-mapping-pipeline/",
    config_directory = "~/git/cholera-configs/Dec_2021_runs",
    map_output_dir = "~/git/cholera-mapping-output/continent_map",
    max_countries = Inf
  )
}

options(bitmapType = 'cairo')
knitr::opts_chunk$set(
  echo = FALSE,
  dev = "CairoPNG",
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  cache = FALSE,
  cache.lazy = FALSE,
  error = TRUE,
  bitmapType = "cairo")
```

```{r dir_settings}
dir.create(file.path(params$map_output_dir, "shapefiles/"), showWarnings = FALSE)
```

```{r aggregation, include=FALSE}
### The Setup
## Initialize
final_cache <- new.env() 
final_cache$case_results <- NULL 
final_cache$rate_results <- NULL 
country_caches <- list()
country_count <- 0
complete_country <- c()
sf_cases_resized <- list()
sf_grid <- list()
results <- NULL

## Setup and get all the countries 
all_config_fns <- list.files(paste0(params$cholera_directory, "/", params$config_directory))
all_countries <- stringr::str_extract(all_config_fns, "[A-Z]{3}")
if(!is.null(params$separate_TZA)){all_countries <- c(all_countries[all_countries != "TZA"], params$separate_TZA)}
all_countries <- all_countries[!all_countries %in% params$tmp_dropped_countries] #drop the countries with bad output 

error_countries_cases <- all_countries
error_countries_rates <- all_countries

## From countries to certain config files 
all_configs <- new.env() 
invisible(lapply(all_countries, function(country_code){
  all_configs[[country_code]] <- paste(params$config_directory, all_config_fns[grepl(country_code, all_config_fns)], sep = "/")
}))



### Loop through each country 
for(country in all_countries) {

  ## For efficiency reason
  if(country %in% complete_country){next} 
  
  ## First the case raster 
  tryCatch({ 
    country_cache <- new.env()
    config_filename <- all_configs[[country]] 
    if(country_count >= params$max_countries){break}

    taxdat:::merge_modeled_cases_mean_into_raster(name="modeled_cases_mean_raster", config = config_filename, cache = country_cache, cholera_directory = params$cholera_directory)
    remove_dropped_years(country_cache, country, params$dropped_years, params$modeled_years) 
    continent_map_mean_across_years(cache = country_cache, sf_type = "case")

    if(is.null(final_cache$case_results)) {
      final_cache$case_results <- country_cache$modeled_cases_mean_raster_mean_across_years %>% 
        select(modeled_cases_mean_across_years) %>% 
        mutate(country_code = country)
    } else {
      final_cache$case_results <- rbind(final_cache$case_results, country_cache$modeled_cases_mean_raster_mean_across_years %>% 
                                                                    select(modeled_cases_mean_across_years) %>% 
                                                                    mutate(country_code = country)
                                        )
    } 
    # error_countries_cases <- error_countries_cases[error_countries_cases != all_countries[all_configs[[country]] == config_filename] ]
  }, 
  error = function(e){
    warning(paste(config_filename,"failed with message", e$message))
  })

  ## Then the rate raster 
  tryCatch({ 
    #country_cache <- new.env()
    config_filename <- all_configs[[country]] 
    if(country_count >= params$max_countries){break}

    taxdat:::merge_modeled_rates_mean_into_raster(name="modeled_rates_mean_raster", config = config_filename, cache = country_cache, cholera_directory = params$cholera_directory)
    remove_dropped_years(country_cache, country, params$dropped_years, params$modeled_years) 
    continent_map_mean_across_years(cache = country_cache, sf_type = "rate")

    if(is.null(final_cache$rate_results)) {
      final_cache$rate_results <- country_cache$modeled_rates_mean_raster_mean_across_years %>% 
        select(modeled_rates_mean_across_years) %>% 
        mutate(country_code = country)
    } else {
      final_cache$rate_results <- rbind(final_cache$rate_results, country_cache$modeled_rates_mean_raster_mean_across_years %>% 
                                                                    select(modeled_rates_mean_across_years) %>% 
                                                                    mutate(country_code = country)
                                        )
    } 
  
  }, 
  error = function(e){
    warning(paste(config_filename,"failed with message", e$message))
  })

  ## Genquant - the case table
  country_cache <- new.env()
  process_genquant(config = config_filename, country_cache = country_cache, cholera_directory = params$cholera_directory)
  stitch_genquant(country_cache, final_cache, admin_level = "ADM0")

  country_count <- country_count + 1 
  complete_country <- c(complete_country, country)
  
}
```

# Continent Map of Cases
```{r map_plotting_case, echo=FALSE, fig.height=10,fig.width=10} 
plot_continent_map_sf(outputmap_dir = gsub("Analysis/output/", "", params$map_output_dir), 
                      country_borders = TRUE, 
                      continent_sf = final_cache$case_results, 
                      sf_type = "case")
```

# Continent Map of Rates
```{r map_plotting_rate, echo=FALSE, fig.height=10,fig.width=10} 
plot_continent_map_sf(outputmap_dir = gsub("Analysis/output/", "", params$map_output_dir), 
                      country_borders = TRUE, 
                      continent_sf = final_cache$rate_results, 
                      sf_type = "rate")
```

# Continent Tables
## Continent table -- cases by location and year
```{r out-table-cases}
final_cache$case_table %>% 
  dplyr::select(-admin_level) %>% 
  kableExtra::kbl(caption = "Cases by location and year") %>% 
  kableExtra::kable_styling(full_width = FALSE) %>% 
  kableExtra::pack_rows(index = table(final_cache$case_table$admin_level))

```
## Continent table -- rates by location and year
```{r out-table-rates}
final_cache$rate_table %>% 
  dplyr::select(-admin_level) %>% 
  kableExtra::kbl(caption = "Rates by location and year") %>% 
  kableExtra::kable_styling(full_width = FALSE) %>% 
  kableExtra::pack_rows(index = table(final_cache$rate_table$admin_level))

```
## Continent table -- population by location and year
```{r out-table-pop}
final_cache$pop_table %>% 
  dplyr::select(-admin_level) %>% 
  kableExtra::kbl(caption = "Population by location and year") %>% 
  kableExtra::kable_styling(full_width = FALSE) %>% 
  kableExtra::pack_rows(index = table(final_cache$pop_table$admin_level))

```
