---
title: "Country Data Report"
output: 
  html_document:
    toc: true
    toc_float: true
params: 
  cholera_directory: "/.../cholera-mapping-pipeline"
  config: "Analysis/configs/.../*.yml"
  drop_nodata_years: TRUE
  admin_level_for_summary_table: '1'
  args: 'myarg'
  old_runs: FALSE
---

```{r setup, include=FALSE, dev="CairoPNG",message=FALSE}
### All packages
chooseCRANmirror(ind = 77)

package_list <- c(
  "yaml", 
  "knitr", 
  #"stringr", 
  "cli", 
  "purrr",
  "dplyr", 
  "magrittr", 
  "readr", 
  "ggplot2", 
  "kableExtra", 
  "ISOcodes", 
  "igraph", 
  "taxdat",
  "sf", 
  "sp", 
  "raster",
  "abind", 
  "stars", 
  "ggthemes",
  "scales",  
  "fasterize", 
  "remotes",
  "rgeoboundaries", 
  "MCMCvis", 
  "coda", 
  "ggrepel", 
  "urltools", 
  "cmdstanr"
)

run_on_marcc <- as.logical(Sys.getenv("RUN_ON_MARCC",FALSE))
if(run_on_marcc){
  r_library_directory <- Sys.getenv("R_LIBRARY_DIRECTORY", FALSE)
  package_exp <- 
    'for (package in package_list) {
      if (!require(package = package, character.only = T, lib = r_library_directory)) {
        if (package == "rgeoboundaries"){
          try({
            remotes::install_gitlab("dickoa/rgeoboundaries", lib = r_library_directory)
            remotes::install_github("wmgeolab/rgeoboundaries", lib = r_library_directory)
          })
        }else{
          install.packages(pkgs = package, lib = r_library_directory)
          library(package = package, character.only = T, lib = r_library_directory)
        }
      }else{
        library(package = package, character.only = T, lib = r_library_directory)
      }
    }
    library(rstan)
    library(package = Cairo)
    '

}else{
  package_exp <- 
    'for (package in package_list) {
      if (!require(package = package, character.only = T)) {
        if (package == "rgeoboundaries"){
          try({
            remotes::install_gitlab("dickoa/rgeoboundaries")
            remotes::install_github("wmgeolab/rgeoboundaries")
          })
        }else{
          install.packages(pkgs = package)
          library(package = package, character.only = T)
        }
      }else{
        library(package = package, character.only = T)
      }
    }'
}
package_exp <- parse(text = c(package_exp))
invisible(purrr::map(package_exp, eval))
library(stringr)
sf::sf_use_s2(FALSE)

### Rmarkdown file settings
knitr::opts_chunk$set(
  cache=FALSE,
  cache.lazy = FALSE,
  echo = FALSE,
  dev="CairoPNG",
  error = FALSE,
  fig.align = "center",
  message = TRUE,
  warning = TRUE
)
capFigNo = 1

capFig = function(x){
  x = paste0("Figure ",capFigNo,". ",x)
  capFigNo <<- capFigNo + 1
  x
}

### Debug
options(error = traceback)

```

# Mapping results summary for `r stringr::str_extract(params$config, "[A-Z]{3}")` and period `r stringr::str_extract(params$config, "[0-9]{4}_[0-9]{4}")`

## Cholera data input
**Data input:**
```{r load data,message=FALSE}
# Load data
cache<-new.env()
config_file<-yaml::read_yaml(paste0(params$cholera_directory,"/",params$config))

get_stan_input(name="stan_input",cache=cache,config = params$config,cholera_directory = params$cholera_directory)
get_sf_cases_resized(name="sf_cases_resized",cache=cache,config = params$config,cholera_directory = params$cholera_directory)
get_sf_cases(name="sf_cases",cache=cache,config=params$config,cholera_directory=params$cholera_directory)

get_genquant(name="genquant",cache=cache,config=params$config,cholera_directory = params$cholera_directory)
get_model_rand(name="model.rand",cache=cache,config = params$config,cholera_directory = params$cholera_directory)
get_modeled_cases(name="modeled_cases",cache=cache,config=params$config,cholera_directory = params$cholera_directory)
get_modeled_rates(name="modeled_rates",cache=cache,config = params$config,cholera_directory = params$cholera_directory)

cache[["modeled_cases_by_chain"]]<-aggregate_modeled_cases_by_chain_no_cache(cache=cache,config = params$config,cholera_directory = params$cholera_directory)
cache[["cases_chains"]]<-aggregate_modeled_cases_by_chain_gridtime_no_cache(cache=cache,config = params$config,cholera_directory = params$cholera_directory)
cache[["niter_per_chain"]]<-get_stan_model_niter_per_chain_no_cache(cache=cache,config = params$config,cholera_directory = params$cholera_directory)
cache[["nchain"]]<-get_stan_model_nchain_no_cache(cache=cache,config = params$config,cholera_directory = params$cholera_directory)
cache[["stan_output"]]<-get_stan_output_no_cache(cache=cache,config = params$config,cholera_directory = params$cholera_directory)

get_initial_values(name="initial_values_data",cache=cache,config = params$config,cholera_directory = params$cholera_directory)
if(config_file$warmup){
cache[["gam_output_df"]]<-get_gam_values_no_cache(cache=cache,config = params$config,cholera_directory = params$cholera_directory)
}

get_covar_cube (name="covar_cube", config = params$config,cache=cache,cholera_directory = params$cholera_directory)
get_sf_grid(name="sf_grid",config = params$config,cache=cache,cholera_directory = params$cholera_directory)

#gen_quant data input
file_names <- taxdat::get_filenames(
  config = str_c(params$cholera_directory, params$config, sep = "/") %>% yaml::read_yaml(), 
  cholera_directory = params$cholera_directory)
get_output_shapefiles(name="output_shapefiles", config = params$config,cache=cache,cholera_directory = params$cholera_directory)
```

```{r output}
#genquant data
# Get cases and rates summaries
cases <- cache[["genquant"]]$summary(variables = "location_cases_output", 
                          c(posterior::default_summary_measures(),
                            posterior::default_convergence_measures()),
                          .cores = 4) %>% 
  mutate(id = str_extract(variable, "[0-9]+") %>% as.numeric(),
         location_period_id = cache[["stan_input"]]$fake_output_obs$locationPeriod_id[id],
         TL = cache[["stan_input"]]$fake_output_obs$TL[id])

rates <- cache[["genquant"]]$summary(variables = "location_rates_output", 
                          c(posterior::default_summary_measures(),
                            posterior::default_convergence_measures()),
                          .cores = 4) %>% 
  mutate(id = str_extract(variable, "[0-9]+") %>% as.numeric(),
         location_period_id = cache[["stan_input"]]$fake_output_obs$locationPeriod_id[id],
         TL = cache[["stan_input"]]$fake_output_obs$TL[id])
pop <- cache[["genquant"]]$summary(variables = "pop_loctimes_output",
                          c(posterior::default_summary_measures(),
                            posterior::default_convergence_measures()),
                          .cores = 4)%>% 
  mutate(id = str_extract(variable, "[0-9]+") %>% as.numeric(),
         location_period_id = cache[["stan_input"]]$fake_output_obs$locationPeriod_id[id],
         TL = cache[["stan_input"]]$fake_output_obs$TL[id])

output_data <- cache[["output_shapefiles"]] %>% 
  inner_join(cases %>% dplyr::select(cases = mean, 
                                     cases_q5 = q5,
                                     cases_q95 = q95,
                                     location_period_id, TL)) %>% 
  inner_join(rates %>% dplyr::select(rate = mean, 
                                     rate_q5 = q5,
                                     rate_q95 = q95,
                                     location_period_id, TL)) %>%
  inner_join(pop %>% dplyr::select(pop = mean,
                                     location_period_id, TL))

# Data over whole period

# Sum of cases by location for whole period

if(config_file$countries_name=="ZNZ"){
  cache[["output_shapefiles"]]<-cache[["output_shapefiles"]][str_detect(cache[["output_shapefiles"]]$location_period_id,"TZA-ADM0-TZA|TZA-ADM1-TZA.18_1|TZA-ADM1-TZA.19_1|TZA-ADM1-TZA.28_1|TZA-ADM1-TZA.29_1|TZA-ADM1-TZA.30_1|TZA-ADM2-TZA.19.1_1|TZA-ADM2-TZA.28.1_1|TZA-ADM2-TZA.28.2_1|TZA-ADM2-TZA.29.1_1|TZA-ADM2-TZA.29.2_1|TZA-ADM2-TZA.30.3_1|TZA-ADM2-TZA.30.4_1|TZA-ADM2-TZA.18.1_1|TZA-ADM2-TZA.30.2_1|TZA-ADM2-TZA.19.2_1|TZA-ADM2-TZA.18.2_1"),]
}

tot_cases <- cache[["genquant"]]$summary(variables = "location_total_cases_output", 
                              c(posterior::default_summary_measures(),
                                posterior::default_convergence_measures()),
                              .cores = 4) %>% 
  mutate(id = str_extract(variable, "[0-9]+") %>% as.numeric(),
         location_period_id = cache[["output_shapefiles"]]$location_period_id[id],
         shapeName = cache[["output_shapefiles"]]$shapeName[id],
         admin_level = cache[["output_shapefiles"]]$admin_level[id])

# Mean rates by location for whole period
tot_rates <- cache[["genquant"]]$summary(variables = "location_total_rates_output", 
                              c(posterior::default_summary_measures(),
                                posterior::default_convergence_measures()),
                              .cores = 4) %>% 
  mutate(id = str_extract(variable, "[0-9]+") %>% as.numeric(),
         location_period_id = cache[["output_shapefiles"]]$location_period_id[id],
         shapeName = cache[["output_shapefiles"]]$shapeName[id],
         admin_level = cache[["output_shapefiles"]]$admin_level[id])

# Mean pop by location for whole period
tot_pop <- cache[["genquant"]]$summary(variables = "pop_loctimes_output", 
                              c(posterior::default_summary_measures(),
                                posterior::default_convergence_measures()),
                              .cores = 4) %>% 
  mutate(id = str_extract(variable, "[0-9]+") %>% as.numeric(),
         location_period_id = cache[["output_shapefiles"]]$location_period_id[id],
         shapeName = cache[["output_shapefiles"]]$shapeName[id],
         admin_level = cache[["output_shapefiles"]]$admin_level[id])
```

```{r out-shape,fig.height=5,fig.width=10,fig.cap=capFig("Shapefiles used for output summaries pulled form rgeoboundaries")}
ggplot(cache[["output_shapefiles"]]) +
  geom_sf() +
  ggrepel::geom_label_repel(
    aes(label = shapeName, geometry = geom),
    stat = "sf_coordinates",
    min.segment.length = 0,
    size = 2,
    max.overlaps = Inf,
    alpha = .8
  )  +
  facet_wrap(~admin_level) +
  theme_map()
```

**Table 1. Data used within the model:**
```{r echo = FALSE}
plot_ObservationSummary_table(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

**Table 2. Data dropped from the model:**
```{r echo=FALSE}
plot_DroppedData_table (config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

**Averaged annual cases by spatial scales:**
```{r disjoint set sf cases, message=FALSE}
aggregate_observed_polygon_cases_disjoint_aggregated(name="observed_polygon_cases_disjoint_aggregated",config=params$config,cholera_directory=params$cholera_directory,cache=cache)
disjoint_set_sf_cases <- cache[["observed_polygon_cases_disjoint_aggregated"]]
```
```{r rawobsmap, fig.height=30, fig.width=30, out.width="150%",fig.cap=capFig("Observed case counts by time adjusted for time fraction cases/year")}
plot_observed_cases_polygon_raw(config=params$config,cache=cache,cholera_directory=params$cholera_directory) 
```

**Averaged area adjusted annual cases by spatial scales:**
```{r areadjustedmap, fig.height=30, fig.width=30, out.width="150%",fig.cap=capFig("Area adjusted average observed case counts by time adjusted for time fraction cases/(year * kilometer)")}
plot_area_adjusted_observed_cases(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

**Number of observations by unique observed location periods:**
```{r obsmap, fig.height=30, fig.width=30, out.width="150%",fig.cap=capFig("Number of observations by unique observed location periods.")}
plot_raw_observations(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

## Output maps and tables
```{r importcase}
cache[["case_raster"]] <-get_case_raster(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
cache[["disaggregated_rate_sf"]]<-get_disaggregated_rates_sf(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
cache[["disaggregated_case_sf"]]<-get_disaggregated_cases_sf (cache=cache,config=params$config,cholera_directory=params$cholera_directory)

analysis_years <- lubridate::year(config_file$start_time):lubridate::year(config_file$end_time)
obs_years <- min(lubridate::year(cache[["sf_cases_resized"]]$TL)):max(lubridate::year(cache[["sf_cases_resized"]]$TR))

 if(all(analysis_years %in% obs_years)){
   message("All analysis years are represented by OCs.")
 } else{
   drop_year_ix <- which(!analysis_years %in% obs_years)
   message(paste(paste(analysis_years[drop_year_ix], collapse = ", "), "are not represented in OCs"))
   if(params$drop_nodata_years){
     message(paste("Dropping", paste(analysis_years[drop_year_ix], collapse = ", "), "from case_raster"))
     cache[["case_raster"]] <- dplyr::filter(cache[["case_raster"]], !(t %in% drop_year_ix))
   }
 }
```

### Modeled cases
**Modeled cases raster by time slices:**
```{r caserast, fig.cap=capFig("Modeled cases"), fig.height=5, fig.width=10}
plot_disaggregated_modeled_cases_time_varying(config_file=config_file, disaggregated_case_sf=cache[["disaggregated_case_sf"]], add_shp_from_stan_input = T, run_on_marcc = run_on_marcc)
```

```{r out-cases,fig.height=5,fig.width=10,fig.cap=capFig("Mean cases per year")}
output_data %>% 
  ggplot(aes(fill = log10(cases))) +
  geom_sf(col = "white", size = .05) +
  facet_grid(admin_level ~ TL) +
  scale_fill_viridis_c() +
  ggthemes::theme_map() +
  theme(legend.position = "right")

```

**Table 3. Cases by location and year:**
```{r out-table-cases}

cases_summ <- output_data %>%
  st_drop_geometry() %>% 
  dplyr::select(shapeName, admin_level, TL, contains("cases")) %>% 
  mutate(TL = as.character(lubridate::year(TL))) %>% 
  bind_rows(tot_cases %>% 
              rename(cases = mean,
                     cases_q5 = q5,
                     cases_q95 = q95) %>% 
              dplyr::select(shapeName, admin_level, contains("cases")) %>% 
              mutate(TL = "Total")) %>% 
  mutate(text = str_c(
    round(cases), " (",
    round(cases_q5), "-", 
    round(cases_q95), ")"
  )) %>% 
  dplyr::select(shapeName, admin_level, TL, text) %>% 
  pivot_wider(values_from = "text",
              names_from = "TL") %>% 
  arrange(admin_level, shapeName)

cases_summ %>% 
  dplyr::select(-admin_level) %>% 
  kableExtra::kbl(caption = "Cases by location and year") %>% 
  kableExtra::kable_styling(full_width = FALSE) %>% 
  kableExtra::pack_rows(index = table(cases_summ$admin_level))

```

### Modeled incidence rates
**Modeled incidence rates raster by time slices:**
```{r raterast, fig.cap=capFig("Modeled rates by time"), fig.height=5, fig.width=10}
plot_modeled_rates_time_varying(config_file=config_file, disaggregated_rate_sf=cache[["disaggregated_rate_sf"]], add_shp_from_stan_input = T, render = T, run_on_marcc = run_on_marcc)
```
**Modeled incidence rates raster by time slices and chains:**
```{r raterast_bygridtimechain, fig.cap=capFig("Modeled rates by time"), fig.height=8, fig.width=8}
plot_modeled_rates_by_gridtime_chain(config=params$config,cholera_directory=params$cholera_directory,cache=cache,render = T)
```

```{r out-rates,fig.height=5,fig.width=10,fig.cap=capFig("Mean rate per year")}
output_data %>% 
  ggplot(aes(fill = log10(rate))) +
  geom_sf(col = "white", size = .05) +
  facet_grid(admin_level ~ TL) +
  scale_fill_viridis_c() +
  ggthemes::theme_map() +
  theme(legend.position = "right")

```

**Table 4. Rates by location and year:**
```{r out-table-rates}
rate_multiplier <- 1e4

rates_summ <- output_data %>%
  st_drop_geometry() %>% 
  dplyr::select(shapeName, admin_level, TL, contains("rate")) %>% 
  mutate(TL = as.character(lubridate::year(TL))) %>% 
  bind_rows(tot_rates %>% 
              rename(rate = mean,
                     rate_q5 = q5,
                     rate_q95 = q95) %>% 
              dplyr::select(shapeName, admin_level, contains("rate")) %>% 
              mutate(TL = "Total")) %>% 
  mutate(text = str_c(
    (rate * rate_multiplier) %>% formatC(digits = 1, big.mark = "'", format = "f"), " (",
    (rate_q5 * rate_multiplier) %>% formatC(digits = 1, big.mark = "'", format = "f"), "-", 
    (rate_q95 * rate_multiplier) %>% formatC(digits = 1, big.mark = "'", format = "f"), ")"
  )) %>% 
  dplyr::select(shapeName, admin_level, TL, text) %>% 
  pivot_wider(values_from = "text",
              names_from = "TL") %>% 
  arrange(admin_level, shapeName)

rates_summ %>% 
  dplyr::select(-admin_level) %>% 
  kableExtra::kbl(caption = "Cases per 10'000 people by location and year") %>% 
  kableExtra::kable_styling(full_width = FALSE) %>% 
  kableExtra::pack_rows(index = table(cases_summ$admin_level))

```
### Proportion per risk category (per 100'000)
```{r risk_prop,fig.height=5,fig.width=10,fig.cap=capFig("Proportion per risk category (per 100'000)")}
risk_cat_dict <- c("<1", "1-10", "10-100", ">100")

risk_cat_pop <- cache[["genquant"]]$summary(variables = "location_risk_cat_prop", .cores = 6) %>% 
  mutate(id = str_extract(variable, "(?<=\\[)[0-9]+") %>% as.numeric(),
         risk_cat = str_extract(variable, "(?<=,)[0-9]+") %>% as.numeric(),
         risk_cat = factor(risk_cat_dict[risk_cat], levels = risk_cat_dict),
         location_period_id = cache[["output_shapefiles"]]$location_period_id[id],
         admin_level = str_extract(location_period_id, "ADM[0-2]")) %>% 
  inner_join(cache[["output_shapefiles"]], ., by = c("location_period_id", "admin_level"))


risk_cat_pop %>% 
  ggplot(aes(fill = median)) +
  geom_sf(col = "white", size = .05) +
  facet_grid(admin_level ~ risk_cat) +
  scale_fill_viridis_c() +
  ggthemes::theme_map() +
  theme(legend.position = "right")

```
### Number per risk category  (per 100'000)
```{r risk_num,fig.height=5,fig.width=10,fig.cap=capFig("Number per risk category  (per 100'000)")}
risk_cat_dict <- c("<1", "1-10", "10-100", ">100")

risk_cat_num <- cache[["genquant"]]$summary(variables = "location_risk_cat_num", .cores = 6) %>% 
  mutate(id = str_extract(variable, "(?<=\\[)[0-9]+") %>% as.numeric(),
         risk_cat = str_extract(variable, "(?<=,)[0-9]+") %>% as.numeric(),
         risk_cat = factor(risk_cat_dict[risk_cat], levels = risk_cat_dict),
         location_period_id = cache[["output_shapefiles"]]$location_period_id[id],
         admin_level = str_extract(location_period_id, "ADM[0-2]")) %>% 
  inner_join(cache[["output_shapefiles"]], ., by = c("location_period_id", "admin_level"))


risk_cat_num %>% 
  ggplot(aes(fill = log10(median))) +
  geom_sf(col = "white", size = .05) +
  facet_grid(admin_level ~ risk_cat) +
  scale_fill_viridis_c() +
  ggthemes::theme_map() +
  theme(legend.position = "right")

```

### Population
```{r out-pop,fig.height=5,fig.width=10,fig.cap=capFig("Mean pop per year")}
  output_data %>% 
    ggplot(aes(fill = log10(pop))) +
    geom_sf(col = "white", size = .05) +
    facet_grid(admin_level ~ TL) +
    scale_fill_viridis_c() +
    ggthemes::theme_map() +
    theme(legend.position = "right")

```

**Table 5. Pop by location and year:**
```{r out-table-pop}
  pop_summ <- output_data %>%
    st_drop_geometry() %>% 
    dplyr::select(shapeName, admin_level, TL, contains("pop")) %>% 
    mutate(TL = as.character(lubridate::year(TL))) %>% 
    bind_rows(tot_pop %>% 
                rename(pop = mean) %>% 
                dplyr::select(shapeName, admin_level, contains("pop")) %>% 
                mutate(TL = "Total")) %>% 
    mutate(text = str_c(
      round(pop)
    )) %>% 
    dplyr::select(shapeName, admin_level, TL, text) %>% 
    subset(is.na(shapeName)==F) %>%
    pivot_wider(values_from = "text",
                names_from = "TL") %>% 
    arrange(admin_level, shapeName)
  
  pop_summ %>% 
    dplyr::select(-admin_level,-Total) %>% 
    kableExtra::kbl(caption = "Pop by location and year") %>% 
    kableExtra::kable_styling(full_width = FALSE) %>% 
    kableExtra::pack_rows(index = table(pop_summ$admin_level))

```

## Validation
```{r import_modelfidel}
cache[["data_fidelity"]]<-get_data_fidelity(cache=cache,cholera_directory=params$cholera_directory,config=params$config)
```

**Actual observations versus modeled cases scatter plot:**
```{r datafidelity1, fig.cap=capFig("Observations vs. modeled cases"), fig.height=10, fig.width=10}
if(!is.null(cache[["data_fidelity"]])){
plot_model_fidelity_tfrac_adjusted(cache=cache,cholera_directory=params$cholera_directory,config=params$config,render = T)
}else{
  warning("data_fidelity is NULL!")
}
```

```{r datafidelity3, fig.cap=capFig("Observations vs. modeled cases (tfrac adjusted)"), fig.height=15, fig.width=10}
if(!is.null(cache[["data_fidelity"]])){
plot_model_fidelity_tfrac_adjusted_by_year(cache=cache,cholera_directory=params$cholera_directory,config=params$config,render = T)
}else{
  warning("data_fidelity is NULL!")
}
```

```{r datafidelity4, fig.cap=capFig("Observations vs. modeled cases"), fig.height=8, fig.width=10}
if(!is.null(cache[["data_fidelity"]])){
plot_model_fidelity_tfrac_unadjusted(cache=cache,cholera_directory=params$cholera_directory,config=params$config,render = T)
}else{
  warning("data_fidelity is NULL!")
}
```

```{r datafidelity5, fig.cap=capFig("Observation vs. modeled_cases by chains"),fig.height=8,fig.width=10}
if(!is.null(cache[["data_fidelity"]])){
plot_model_fidelity_by_chain(cache=cache,cholera_directory=params$cholera_directory,config=params$config,render=T)
}else{
  warning("data_fidelity is NULL!")
}
```

**Table 6. Observed and estimates of WHO annual cholera reports based on the observation-level modeled cases with other sources of annual data added:**
```{r WHO output, fig.height=510, fig.width=10, fig.cap = "comparison with WHO Output"}
plot_WHOcomparison_table(config=params$config, cache=cache, cholera_directory=params$cholera_directory, 
  allow_data_pull = !run_on_marcc, add_other_source = TRUE)
```


## Model Convergence 
**Stan trace plots:**
```{r traceplots, fig.height=8, fig.width=10, fig.cap=capFig("Stan trace plots")}
plot_chain_convergence(name="model.rand",cache=cache,config=params$config,cholera_directory=params$cholera_directory,
                       model_output_filenames=file_names[["stan_output"]])
```

**Parameter posteriors:**
```{r params, fig.height=6, fig.width=6, fig.cap=capFig("Parameter posteriors")}
plot_MCMCpars(name="model.rand",cache=cache,config=params$config,cholera_directory = params$cholera_directory)
```

**Gelman-Rubin Rhat:**
```{r rhat, fig.height=5, fig.width=10, fig.cap=capFig("Gelman-Rubin Rhat")}
plot_Rhat(name="model.rand",cache)
```
**W distribution:**
```{r w_distribution, fig.height=5, fig.width=5, fig.cap=capFig("W distribution")}
plot_w_mean(cache = cache, config = params$config, cholera_directory = params$cholera_directory)
```

**Table 7. Estimated cases by chain and time slice:**
```{r cases_chain_table, fig.width=10, fig.cap = "Sum of grid cases by chain and year"}
plot_modeled_cases_by_chain_time (config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

```{r full country modeled cases, fig.cap = "comparison with WHO Output"}
total_cases <- cache[["modeled_cases"]] %>% apply(3, mean) %>% sum()
print(paste("There are",format(round(total_cases), big.mark=","),"total cases"))
```

## Others 
### Config Parameters
**Table 8. Parameters used within the model:**
```{r echo = FALSE}
config_file <- yaml::read_yaml(paste0(params$cholera_directory, "/", params$config), eval.expr = TRUE)
print(config_file)
```

### GAM Input
**Observations input for the GAM model:**
```{r gam input of cases,fig.height=10, fig.width=15, fig.cap=capFig("Observations input for the GAM model (cases)")}
if(config_file$warmup){
plot_gam_fit_input (name="initial_values_data", cache=cache, mean=FALSE, type="cases")
}
```

```{r gam input of rates,fig.height=10, fig.width=15, fig.cap=capFig("Observations input for the GAM model (rates)")}
if(config_file$warmup){
plot_gam_fit_input (name="initial_values_data", cache=cache, mean=FALSE, type="rates")
}
```

```{r gam input of observations,fig.height=10, fig.width=15, fig.cap=capFig("Number of observations per grid cell for the GAM model")}
if(config_file$warmup){
plot_gam_fit_input (name="initial_values_data", cache=cache, mean=FALSE, type="observations")
}
```

```{r variance of cases in gam input,fig.height=10, fig.width=15, fig.cap=capFig("Variance of cases in gam input per grid cell")}
if(config_file$warmup){
plot_gam_fit_input (name="initial_values_data", cache=cache, mean=FALSE, type="case variance")
}
```

```{r variance of rates in gam input,fig.height=10, fig.width=15, fig.cap=capFig("Variance of rates per 100000 in gam input per grid cell")}
if(config_file$warmup){
plot_gam_fit_input (name="initial_values_data", cache=cache, mean=FALSE, type="rate variance")
}
```

### GAM Output
**Observations output of the GAM model:**
```{r gam output of cases,fig.height=10, fig.width=15, fig.cap=capFig("Observations output from the GAM model (cases)")}
if(config_file$warmup){
plot_gam_fit_output(name="gam_output_df",cache=cache,type='cases')
}
```

```{r gam output of rates,fig.height=10, fig.width=15, fig.cap=capFig("Observations output from the GAM model (rates)")}
if(config_file$warmup){
plot_gam_fit_output(name="gam_output_df",cache=cache,type='rates')
}
```

### GAM Output v.s GAM Input Comparison
**GAM Output v.s Raw GAM Input Rates Scatterplot:**
```{r gam output input rates comparison,fig.height=10, fig.width=15, fig.cap=capFig("GAM Output v.s Raw GAM Input Rates")}
if(config_file$warmup){
plot_gam_input_vs_output_rate_scatter_plot(cache = cache, type = 'raw') 
}
```
**GAM Output v.s Averaged GAM Input Rates Scatterplot:**
```{r gam output input rates comparison averaged,fig.height=10, fig.width=15, fig.cap=capFig("GAM Output v.s Averaged GAM Input Rates")}
if(config_file$warmup){
plot_gam_input_vs_output_rate_scatter_plot(cache = cache, type = 'averaged') 
}
```

### Stan Output v.s GAM Output
**Stan Output v.s GAM Output Rates by Time Slices:**
```{r stangamrates, fig.cap=capFig("Stan Output v.s GAM Output Rates"), fig.height=5, fig.width=10}
if(config_file$warmup){
plot_stan_output_vs_gam_output_rate_scatter_plot(cache = cache)
}
```

**Stan Output v.s GAM Output Cases by Time Slices:**
```{r stangamcates, fig.cap=capFig("Stan Output v.s GAM Output Cases"), fig.height=5, fig.width=10}
if(config_file$warmup){
plot_stan_output_vs_gam_output_case_scatter_plot(cache = cache) #this will output plots 
}
```

### Covariates
#### Other covariates
**Covariate rasters:**
```{r covars, fig.height=5, fig.width=10, fig.cap=capFig("Covariate rasters")}
if(length(dimnames(cache[["covar_cube"]])[[3]])>=2){
plot_raster_covariates(cache=cache,cholera_directory=params$cholera_directory,config=params$config)
}else{
  warning("no covariates")
}
```

**Table 9. Time for each chain:**
```{r analysisyears}
obs_years <- min(lubridate::year(cache[["stan_input"]]$sf_cases_resized$TL)):max(lubridate::year(cache[["stan_input"]]$sf_cases_resized$TR))
time_tmp <- rstan::get_elapsed_time(cache[["model.rand"]])
time_table <- tibble::tibble( chain = paste("Chain", 1:nrow(time_tmp)), 
                              warmup = dplyr::case_when(  all(time_tmp[, 1] > 60*60*24) ~ paste((time_tmp[, 1] / (60*60*24)), "(days)"), 
                                                          all(time_tmp[, 1] > 60*60   ) ~ paste((time_tmp[, 1] / (60*60   )), "(hours)"),
                                                          all(time_tmp[, 1] > 60      ) ~ paste((time_tmp[, 1] / (60      )), "(minutes)"), 
                                                          TRUE ~  paste(time_tmp[, 1], "(seconds)") 
                                                        ), 
                              sample = dplyr::case_when(  all(time_tmp[, 2] > 60*60*24) ~ paste((time_tmp[, 2] / (60*60*24)), "(days)"), 
                                                          all(time_tmp[, 2] > 60*60   ) ~ paste((time_tmp[, 2] / (60*60   )), "(hours)"),
                                                          all(time_tmp[, 2] > 60      ) ~ paste((time_tmp[, 2] / (60      )), "(minutes)"), 
                                                          TRUE ~  paste(time_tmp[, 2], "(seconds)") 
                                                        )
                            )

time_table %>%
    kableExtra::kable(col.names = c("Chain", "Warm-up", "Sample")) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped")) %>%
    kableExtra::kable_paper(full_width = F)
```
