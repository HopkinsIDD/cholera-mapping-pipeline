---
title: "Country Data Report"
output: html_document
params:
  cholera_directory: "../../"
  config: "Analysis/configs/config.yml"
  drop_nodata_years: TRUE
---
```{r setup, include=FALSE, dev="CairoPNG",message=FALSE}
library(knitr)
knitr::opts_chunk$set(
  cache=FALSE,
  cache.lazy = FALSE,
  echo = FALSE,
  dev="CairoPNG",
  error = FALSE,
  fig.align = "center",
  message = TRUE,
  warning = TRUE
  )
library(stringr)
library(dplyr)
library(magrittr)
library(purrr)
library(readr)
library(ggplot2)
library(kableExtra)
library(taxdat)
library(sf)
library(raster)
library(stars)
library(taxdat)
sf::sf_use_s2(FALSE)

### other new packages (mainly for "rgeoboundaries")
chooseCRANmirror(ind = 77)

package_list <- c(
  "fasterize",
  "remotes",
  "rgeoboundaries"
)

for (package in package_list) {
  if (!require(package = package, character.only = T)) {
    if (package == "rgeoboundaries"){
      try({
        remotes::install_gitlab("dickoa/rgeoboundaries")
        remotes::install_github("wmgeolab/rgeoboundaries")
      })
    }else{
      install.packages(pkgs = package)
      library(package = package, character.only = T)
    }
  }
}

#Figure Caption Numbering,
capFigNo = 1
#Function to add the Figure Number
capFig = function(x){
    x = paste0("Figure ",capFigNo,". ",x)
    capFigNo <<- capFigNo + 1
    x
}
cache<-new.env()

```

# Mapping results summary for `r stringr::str_extract(params$config, "[A-Z]{3}")` and period `r stringr::str_extract(params$config, "[0-9]{4}_[0-9]{4}")`


``` {r echo=FALSE}
get_config(cache=cache,config=params$config,cholera_directory=params$cholera_directory)

if(!is.null(cache[["config"]][["test_metadata"]])){
  general_parameters_table <- cache[["config"]][["test_metadata"]][c("raster", "polygons", "grid_observation")] %>%
    as.data.frame() %>%

    t() %>%
    as.data.frame() %>%
    tibble::rownames_to_column() %>%
    rbind(data.frame(rowname = "Number of covariates", V1 = length(cache[["config"]][["test_metadata"]][["covariates"]]))) %>%
    kableExtra::kable(col.names = c("Parameter","Values"),
      caption = "Table 1. Parameters") %>%
    kableExtra::kable_styling(bootstrap_options = c("striped"))

  covariate_parameters_table <- cache[["config"]][["test_metadata"]][["covariates"]] %>%
    lapply(function(covariate_spec) {
      as.data.frame(covariate_spec)
    }) %>%
    do.call(what=rbind) %>%
    dplyr::mutate(covariate_name = paste("covariate", seq_len(length(cache[["config"]][["test_metadata"]][["covariates"]])))) %>%
    kableExtra::kable(caption = "Table 2. Covariate Parameters") %>%
    kableExtra::kable_styling(bootstrap_options = c("striped"))

  observation_parameters_table <- cache[["config"]][["test_metadata"]][["observations"]] %>%
    lapply(function(observation_spec) {
      as.data.frame(observation_spec)
    }) %>%
    do.call(what=rbind) %>%
    dplyr::mutate(
      tfrac = mapply(s = start_date, e = end_date, FUN= function(s,e){
        as.numeric(lubridate::as.period(lubridate::interval(lubridate::ymd(s),lubridate::ymd(e) + 1), units = cache[["config"]][["general"]][["time_scale"]]), units = cache[["config"]][["general"]][["time_scale"]])
      })
    ) %>%
    kableExtra::kable(caption = "Table 2. Covariate Parameters") %>%
    kableExtra::kable_styling(bootstrap_options = c("striped"))

  general_parameters_table
}else {
  return(invisible(NULL))
}
```

``` {r echo=FALSE}
if(!is.null(cache[["config"]][["test_metadata"]])){
  covariate_parameters_table
}else {
  return(invisible(NULL))
}
```

``` {r echo=FALSE}
if(!is.null(cache[["config"]][["test_metadata"]])){
  observation_parameters_table
}else {
  return(invisible(NULL))
}
```

## Cholera input data

**Table 1. Data used within the model:**
```{r Observation Summary Table, echo = FALSE}
 taxdat::table_observation_summary(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

**Table 2. Data dropped from the model:**
```{r echo=FALSE}
taxdat::table_dropped_data(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

```{r disjoint set sf cases, message=FALSE}
# aggregate_observed_polygon_cases_disjoint_aggregated(name="observed_polygon_cases_disjoint_aggregated",config=params$config,cholera_directory=params$cholera_directory,cache=cache)
# disjoint_set_sf_cases <- cache[["observed_polygon_cases_disjoint_aggregated"]]
```

**Annual average cases by unique location periods:**
```{r rawobsmap, fig.height=5, fig.width=10, fig.cap=capFig("Observed case counts by time adjusted for time fraction cases/year")}
taxdat::plot_observed_cases_polygon_raw(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

**Annual average area adjusted cases by unique location periods:**
```{r areadjustedmap, fig.height=5, fig.width=10, fig.cap=capFig("Area adjusted average observed case counts by time adjusted for time fraction cases/(year * kilometer)")}
taxdat::plot_area_adjusted_observed_cases(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

**Number of observations by unique location periods:**
```{r obsmap, fig.height=5, fig.width=10, fig.cap=capFig("Number of observations by unique observed location periods.")}
taxdat::plot_raw_observations(config=params$config,cache=cache,cholera_directory=params$cholera_directory)
```

### Covariates

#### Population
**Population raster by time slices (log scale):**
```{r pop, fig.height=5, fig.width=10, fig.cap=capFig("Population density")}
taxdat::plot_time_varying_pop_raster(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
```

**Table 3. Population by admin level:**
```{r echo = FALSE}
warning("Removed this plot for now")
# taxdat::plot_pop_by_admin(cache=cache,cholera_directory=params$cholera_directory,config=params$config)
```

#### Other covariates
**Covariate rasters:**
```{r covars, fig.height=10, fig.width=10, fig.cap=capFig("Covariate rasters")}
taxdat::plot_raster_covariates(cache=cache,cholera_directory=params$cholera_directory,config=params$config)
```

``` {r covars_data_simulation, fig.height=10, fig.width=10, fig.cap=capFig("Non-population covariate rasters in data simulation process")}
taxdat::plot_raster_covariates_datagen(cache=cache,cholera_directory=params$cholera_directory,config=params$config)
```

### GAM Input
**Observations input for the GAM model:**
```{r gam input of cases,fig.height=5, fig.width=10, fig.cap=capFig("Observations input for the GAM model (cases)")}
taxdat::plot_gam_fit_input_cases(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

```{r gam input of rates,fig.height=5, fig.width=10, fig.cap=capFig("Observations input of the GAM model (rates)")}
taxdat::plot_gam_fit_input_rates(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

### GAM Output
**Observations output of the GAM model:**
```{r gam output of cases,fig.height=5, fig.width=10, fig.cap=capFig("Observations output for the GAM model (cases)")}
taxdat::plot_gam_fit_output_cases(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

```{r gam output of rates,fig.height=5, fig.width=10, fig.cap=capFig("Observations output for the GAM model (rates)")}
taxdat::plot_gam_fit_output_rates(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

### True underlying distribution maps
#### Ture underlying distribution of cases
**True grid cases raster by time slices:**
```{r underlying distribution of cases,fig.cap=capFig("True underlying distribution of cases"), fig.height=5, fig.width=10}
 plot_true_grid_cases(config=params$config,cholera_directory=params$cholera_directory,cache=cache)
```

#### Ture underlying distribution of incidece rates
**True grid incidence raster by time slices:**
```{r underlying distribution of incidence rates,fig.cap=capFig("True underlying distribution of rates"), fig.height=5, fig.width=10}
 plot_true_grid_rates(config=params$config,cholera_directory=params$cholera_directory,cache=cache)
```

### Output maps

```{r importcase}
get_dropped_years(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
if(length(cache[["dropped_years"]]) == 0){
  message("All modeled years are represented by OCs.")
} else {
  message(paste(paste(cache[["dropped_years"]], collapse = ", "), "are not represented in OCs"))
  if(params$drop_nodata_years){
    message(paste("Dropping", paste(cache[["dropped_years"]], collapse = ", "), "from case_raster"))
  }
}
```

#### Modeled cases
**Modeled cases raster by time slices:**
```{r caserast, fig.cap=capFig("Modeled cases"), fig.height=5, fig.width=10}
plot_disaggregated_modeled_cases_time_varying(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Table 4. Modeled cases by admin level and time:**
```{r echo = FALSE}
warning("Skipping this one for now, since it should be done via sfrac")
# table_cases_by_admin(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
```

#### Modeled incidence rates
**Modeled incidence rates raster by time slices:**
```{r raterast, fig.cap=capFig("Modeled rates by time"), fig.height=5, fig.width=10}
plot_modeled_rates_time_varying(
  config = params$config,
  cache = cache,
  cholera_directory = params$cholera_directory
)
```

**Table 5. Modeled population-weighted incidence rates by admin level and time:**
```{r echo = FALSE}
warning("Skipping this one since it should be done via sfrac")
# plot_incidence_by_admin(cache=cache,config=params$config,cholera_directory=params$cholera_directory)
```

### Validation

**Actual observations versus modeled cases scatter plot:**
```{r datafidelity1, fig.cap=capFig("Observations vs. modeled cases"), fig.height=10, fig.width=10}
plot_model_fidelity_tfrac_adjusted(
  config = params$config,
  cache = cache,
  cholera_directory = params$cholera_directory
)
```

``` {r datafidelity2, fig.cap=capFig("True vs. modeled grid cases"), fig.height=10, fig.width=10}
plot_true_modeled_grid_cases (
  config = params$config,
  cache = cache,
  cholera_directory = params$cholera_directory
)
```

```{r datafidelity3, fig.cap=capFig("Observations vs. modeled cases (tfrac adjusted)"), fig.height=15, fig.width=10}
warning("Took this one out because it's a bit harder and I was rushing")
# plot_model_fidelity_tfrac_adjusted_by_year(data_fidelity = cache[["data_fidelity"]],case_raster = cache[["case_raster"]],render = T)
```

```{r datafidelity4, fig.cap=capFig("Observations vs. modeled cases"), fig.height=8, fig.width=10}
warning("Took this one out because it was identical to the adjusted figure. Must be missing something")
# plot_model_fidelity_tfrac_unadjusted(data_fidelity = cache[["data_fidelity"]],case_raster = cache[["case_raster"]],render = T)
```

**Stan trace plots:**
```{r traceplots, fig.height=8, fig.width=10, fig.cap=capFig("Stan trace plots")}
taxdat::plot_stan_parameter_traceplot(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Parameter posteriors:**
```{r params, fig.height=10, fig.width=18, fig.cap=capFig("Parameter posteriors")}
taxdat::plot_stan_parameter_violin(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Gelman-Rubin Rhat:**
```{r rhat, fig.height=5, fig.width=10, fig.cap=capFig("Gelman-Rubin Rhat")}
plot_rhat(config = params$config, cache = cache, cholera_directory = params$cholera_directory)
```

**Table 6. Observed and estimates of WHO annual cholera reports:**
```{r WHO output, fig.height=510, fig.width=10, fig.cap = "comparison with WHO Output"}
warning("Skipping this figure for now since I'm not sure what it means for new pipeline")
# plot_WHOcomparison_table(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

**Table 7. Estimated cases by chain and time slice:**
```{r cases_chain_table, fig.width=10, fig.cap = "Sum of grid cases by chain and year"}
table_modeled_cases_by_chain_time(config=params$config, cache=cache, cholera_directory=params$cholera_directory)
```

```{r full country modeled cases, fig.cap = "comparison with WHO Output"}
  warning("This is a weird thing to print")
  total_cases <- sum(cache[["grid_cases_mean"]])
  print(paste("There are",format(round(total_cases), big.mark=","),"total cases"))
```
